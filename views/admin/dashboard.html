<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†åå° | æ•°æ®ä¸­å¿ƒ</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --primary-bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --card-bg: rgba(255, 255, 255, 0.95);
            --text-primary: #1a202c;
            --text-secondary: #718096;
            --accent-color: #667eea;
            --success-color: #00c853;
            --danger-color: #ff5858;
            --sidebar-width: 260px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Poppins', sans-serif; background: var(--primary-bg); height: 100vh; display: flex; overflow: hidden; min-height: 0; }

        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            min-width: var(--sidebar-width);
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            display: flex;
            flex-direction: column;
            padding: 20px;
            overflow-y: auto;
            flex-shrink: 0;
        }
        .brand { font-size: 24px; font-weight: 700; margin-bottom: 40px; display: flex; align-items: center; gap: 10px; }
        .menu-item {
            padding: 12px 16px;
            margin-bottom: 8px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 14px;
            color: rgba(255,255,255,0.7);
        }
        .menu-item:hover, .menu-item.active { background: white; color: var(--accent-color); font-weight: 600; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .menu-item svg { width: 20px; height: 20px; }
        .menu-group { margin-top: 8px; }
        .menu-group-toggle { display: flex; align-items: center; justify-content: space-between; }
        .menu-sub { display: none; margin-top: 6px; padding-left: 10px; }
        .menu-sub.open { display: block; }
        .menu-sub .menu-item { padding: 10px 14px; font-size: 13px; border-radius: 12px; }
        .menu-sub .menu-item::before { content: ""; width: 6px; height: 6px; border-radius: 999px; background: rgba(255,255,255,0.35); display: inline-block; }
        .menu-sub .menu-item.active::before { background: var(--accent-color); }

        /* Main Content */
        .main-content { flex: 1; min-height: 0; padding: 30px 30px 60px; overflow-y: auto; overflow-x: hidden; position: relative; }
        .view-container { display: none; animation: fadeIn 0.3s ease; }
        .view-container.active { display: block; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Stats Cards */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 24px; margin-bottom: 30px; }
        .stat-card { background: var(--card-bg); padding: 24px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        .stat-label { font-size: 14px; color: var(--text-secondary); margin-bottom: 8px; }
        .stat-value { font-size: 28px; font-weight: 700; color: var(--text-primary); }
        .stat-detail { font-size: 12px; color: rgba(255,255,255,0.85); margin-top: 8px; }
        .stat-card.highlight { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .stat-card.highlight .stat-label { color: rgba(255,255,255,0.8); }
        .stat-card.highlight .stat-value { color: white; }

        /* Tables & Lists */
        .content-card { background: var(--card-bg); border-radius: 24px; padding: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); margin-bottom: 24px; }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .card-title { font-size: 18px; font-weight: 600; color: var(--text-primary); }
        
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 16px; color: var(--text-secondary); font-size: 12px; font-weight: 600; border-bottom: 1px solid #eee; }
        td { padding: 16px; color: var(--text-primary); font-size: 14px; border-bottom: 1px solid #f7fafc; }
        .badge { padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .badge-success { background: #e6fffa; color: #00c853; }
        .badge-warning { background: #fffaf0; color: #ed8936; }
        .badge-danger { background: #fff5f5; color: #ff5858; }
        .badge-primary { background: #ebf8ff; color: #4299e1; }

        /* Forms & Inputs */
        input, select { width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 10px; margin-bottom: 16px; font-family: inherit; }
        button { padding: 10px 20px; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; transition: 0.2s; }
        .btn-primary { background: var(--accent-color); color: white; }
        .btn-danger { background: var(--danger-color); color: white; }
        .btn-sm { padding: 6px 12px; font-size: 12px; }

        /* Loading */
        .loading-overlay { position: absolute; inset: 0; background: rgba(255,255,255,0.8); display: none; justify-content: center; align-items: center; z-index: 50; }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--accent-color); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Modal */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 100; overflow-y: auto; padding: 20px 0; }
        .modal-content { background: white; padding: 30px; border-radius: 20px; width: 400px; max-width: 90%; animation: slideUp 0.3s ease; max-height: 80vh; overflow-y: auto; }
        .modal-inner-scroll { max-height: 80vh; overflow-y: auto; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* Toggle Switch */
        .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: 0.3s; border-radius: 24px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: 0.3s; border-radius: 50%; }
        input:checked + .slider { background-color: #48bb78; }
        input:checked + .slider:before { transform: translateX(20px); }

        /* Split View for VIP */
        .split-view { display: grid; grid-template-columns: 350px 1fr; gap: 24px; }
        
        /* Toast */
        #toast { position: fixed; top: 20px; right: 20px; background: #333; color: white; padding: 12px 24px; border-radius: 10px; z-index: 200; transform: translateY(-100px); transition: 0.3s; }

        /* è§†å›¾é¡µé¢æ ‡é¢˜ */
        .view-page-title { font-size: 22px; font-weight: 700; color: var(--text-primary); margin-bottom: 8px; display: flex; align-items: center; gap: 10px; }
        .view-page-desc { font-size: 14px; color: var(--text-secondary); margin-bottom: 24px; line-height: 1.5; }
        /* è®¾ç½®é¡µåˆ†åŒºå¡ç‰‡ */
        .settings-section { background: var(--card-bg); border-radius: 20px; padding: 24px; margin-bottom: 24px; box-shadow: 0 4px 20px rgba(0,0,0,0.06); border: 1px solid rgba(0,0,0,0.04); }
        .settings-section-title { font-size: 16px; font-weight: 600; color: var(--text-primary); margin-bottom: 16px; padding-bottom: 12px; border-bottom: 2px solid #e2e8f0; display: flex; align-items: center; gap: 8px; }
        .form-row { margin-bottom: 16px; }
        .form-row label { display: block; color: var(--text-secondary); font-size: 13px; font-weight: 500; margin-bottom: 6px; }
        .form-row input, .form-row select, .form-row textarea { width: 100%; padding: 12px 14px; border: 1px solid #e2e8f0; border-radius: 10px; font-family: inherit; font-size: 14px; transition: border-color 0.2s; }
        .form-row input:focus, .form-row select:focus, .form-row textarea:focus { outline: none; border-color: var(--accent-color); }
        .form-row .hint { font-size: 12px; color: #a0aec0; margin-top: 6px; }
        /* ç©ºçŠ¶æ€ */
        .empty-state { text-align: center; padding: 48px 24px; color: var(--text-secondary); }
        .empty-state .icon { font-size: 48px; margin-bottom: 12px; opacity: 0.5; }
        /* è´¢åŠ¡ Tab */
        .finance-tabs { display: flex; gap: 4px; margin-bottom: 20px; border-bottom: 2px solid #e2e8f0; }
        .finance-tabs button { padding: 12px 24px; border: none; background: none; color: var(--text-secondary); font-weight: 500; cursor: pointer; border-radius: 8px 8px 0 0; transition: all 0.2s; }
        .finance-tabs button:hover { color: var(--accent-color); background: rgba(102,126,234,0.08); }
        .finance-tabs button.active { color: var(--accent-color); background: white; border-bottom: 2px solid white; margin-bottom: -2px; }
        .mini-stats-row { display: flex; gap: 16px; flex-wrap: wrap; margin-bottom: 20px; }
        .mini-stat { background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%); padding: 12px 20px; border-radius: 12px; font-size: 13px; color: var(--text-secondary); }
        .mini-stat strong { color: var(--text-primary); font-size: 16px; }
    </style>
</head>
<body>

    <nav class="sidebar">
        <div class="brand">âš¡ Admin</div>
        <div class="menu-item active" onclick="switchView('dashboard', event)">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" /></svg>
            ä»ªè¡¨ç›˜
        </div>
        <div class="menu-item" onclick="switchView('users', event)">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
            ç”¨æˆ·ç®¡ç†
        </div>
        <div class="menu-item" onclick="switchView('finance', event)">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
            è´¢åŠ¡å®¡æ‰¹
        </div>
        <div class="menu-item" onclick="switchView('tasks', event)">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" /></svg>
            å•†å“ç®¡ç†
        </div>
        <div class="menu-item" onclick="switchView('vip', event)">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
            VIP ç®¡ç†
        </div>
        <div class="menu-item" onclick="switchView('orderParams', event)">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4" /></svg>
            âš™ï¸ åšå•å‚æ•°
        </div>
        <div class="menu-item" onclick="switchView('agents', event)">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" /></svg>
            ğŸ¤µ ä¸šåŠ¡å‘˜ç®¡ç†
        </div>
        <div class="menu-item" onclick="switchView('reports', event)">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>
            ğŸ“Š æŠ¥è¡¨ç»Ÿè®¡
        </div>
        <div class="menu-group">
            <div class="menu-item menu-group-toggle" onclick="toggleSystemMenu(event)">
                <span style="display:flex; align-items:center; gap:12px;">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                    ç³»ç»Ÿ
                </span>
                <span id="systemMenuArrow" style="opacity:0.7;">â–¸</span>
            </div>
            <div id="systemSubMenu" class="menu-sub">
                <div class="menu-item" onclick="switchView('systemBase', event)">åŸºç¡€ä¸å±•ç¤º</div>
                <div class="menu-item" onclick="switchView('systemFinance', event)">è´¢åŠ¡ä¸æç°</div>
                <div class="menu-item" onclick="switchView('systemContent', event)">è§„åˆ™ä¸å†…å®¹</div>
                <div class="menu-item" onclick="switchView('systemDeposit', event)">å……å€¼æ”¶æ¬¾</div>
                <div class="menu-item" onclick="switchView('systemFinanceConfig', event)">å……å€¼æç°é…ç½®</div>
            </div>
        </div>
        <div class="menu-item" onclick="switchView('loginLogs', event)">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" /></svg>
            ğŸ“¡ ç™»å½•æ—¥å¿— (IP)
        </div>
        <div class="menu-item" onclick="logout()" style="margin-top: auto; color: #ffaaaa;">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
            é€€å‡ºç™»å½•
        </div>
    </nav>

    <div class="main-content">
        <div id="toast">æ“ä½œæˆåŠŸ</div>
        <div class="loading-overlay" id="loading"><div class="spinner"></div></div>

        <div id="dashboardView" class="view-container active">
            <div class="stats-grid" style="grid-template-columns: repeat(3, 1fr);">
                <div class="stat-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    <div class="stat-label" style="color: rgba(255,255,255,0.9);">æ³¨å†Œç”¨æˆ·æ€»æ•°é‡</div>
                    <div class="stat-value" id="statUsers" style="color: white;">0</div>
                    <div class="stat-detail">ä»Šæ—¥æ³¨å†Œç»Ÿè®¡ <span id="statTodayReg">0</span> Â· æ˜¨æ—¥æ³¨å†Œç»Ÿè®¡ <span id="statYesterdayReg">0</span></div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    <div class="stat-label" style="color: rgba(255,255,255,0.9);">ç”¨æˆ·å……å€¼æ€»é¢</div>
                    <div class="stat-value" id="statDeposit" style="color: white;">0</div>
                    <div class="stat-detail">ä»Šæ—¥å……å€¼ç»Ÿè®¡ <span id="statTodayDeposit">0</span> Â· æ˜¨æ—¥å……å€¼ç»Ÿè®¡ <span id="statYesterdayDeposit">0</span></div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    <div class="stat-label" style="color: rgba(255,255,255,0.9);">ç”¨æˆ·æç°æˆåŠŸæ€»é¢</div>
                    <div class="stat-value" id="statWithdraw" style="color: white;">0</div>
                    <div class="stat-detail">ä»Šæ—¥æç°æˆåŠŸ <span id="statTodayWithdraw">0</span> Â· æ˜¨æ—¥æç°æˆåŠŸ <span id="statYesterdayWithdraw">0</span></div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    <div class="stat-label" style="color: rgba(255,255,255,0.9);">å½“æœˆå……å€¼æˆåŠŸæ€»é¢</div>
                    <div class="stat-value" id="statMonthDeposit" style="color: white;">0</div>
                    <div class="stat-detail">ä¸Šæœˆå……å€¼æˆåŠŸæ€»é¢ <span id="statLastMonthDeposit">0</span></div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    <div class="stat-label" style="color: rgba(255,255,255,0.9);">å½“æœˆæç°æˆåŠŸæ€»é¢</div>
                    <div class="stat-value" id="statMonthWithdraw" style="color: white;">0</div>
                    <div class="stat-detail">ä¸Šæœˆæç°æˆåŠŸæ€»é¢ <span id="statLastMonthWithdraw">0</span></div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    <div class="stat-label" style="color: rgba(255,255,255,0.9);">ç»“ç®—ç›ˆåˆ©æ€»é¢</div>
                    <div class="stat-value" id="statProfit" style="color: white;">0.00</div>
                    <div class="stat-detail">å½“æ—¥ç»“ç®—ç›ˆåˆ© <span id="statTodayProfit">0</span> Â· æ˜¨æ—¥ç»“ç®—ç›ˆåˆ© <span id="statYesterdayProfit">0</span></div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;">
                    <div class="stat-label" style="color: rgba(255,255,255,0.9);">å½“å‰åœ¨çº¿ç”¨æˆ·</div>
                    <div class="stat-value" id="statOnline" style="color: white;">0</div>
                    <div class="stat-detail">æœ€è¿‘ 10 åˆ†é’Ÿæœ‰æ´»åŠ¨ Â· å…± <span id="statOnlineCount">0</span> äºº</div>
                </div>
            </div>
            <div class="content-card" style="margin-bottom: 24px;">
                <div class="card-title">åœ¨çº¿ç”¨æˆ·åˆ—è¡¨ï¼ˆæœ€è¿‘ 10 åˆ†é’Ÿæœ‰æ´»åŠ¨ï¼‰</div>
                <div id="onlineUsersList" style="min-height: 60px; font-size: 13px; color: #718096;">åŠ è½½ä¸­...</div>
            </div>
            <div class="stats-charts-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px;">
                <div class="content-card">
                    <div class="card-title">è¿‘åå¤©æ–°å¢ä¼šå‘˜</div>
                    <canvas id="members10dChart" style="max-height: 280px;"></canvas>
                </div>
                <div class="content-card">
                    <div class="card-title">è¿‘åå¤©å……å€¼ç»Ÿè®¡ (U)</div>
                    <canvas id="deposit10dChart" style="max-height: 280px;"></canvas>
                </div>
            </div>
            <div class="content-card">
                <div class="card-title">æœ€æ–°æç°ç”³è¯·</div>
                <div id="recentWithdrawalsList">åŠ è½½ä¸­...</div>
            </div>
            <div class="content-card">
                <div class="card-title">é‚€è¯·è¶‹åŠ¿ï¼ˆæœ€è¿‘30å¤©ï¼‰</div>
                <canvas id="inviteTrendChart" style="max-height: 300px;"></canvas>
            </div>
        </div>

        <div id="usersView" class="view-container">
            <h1 class="view-page-title">ğŸ‘¤ ç”¨æˆ·ç®¡ç†</h1>
            <p class="view-page-desc">æŸ¥çœ‹ä¸ç­›é€‰çœŸå®ç”¨æˆ·ã€åšå•è´¦æˆ·ï¼Œæ”¯æŒèµ„é‡‘è°ƒèŠ‚ã€é‡ç½®å¯†ç ã€ä¿®æ”¹æ¨èå…³ç³»ç­‰æ“ä½œã€‚</p>
            <div class="content-card">
                <div class="card-header">
                    <div class="card-title">ç”¨æˆ·åˆ—è¡¨</div>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <input type="text" id="userSearch" placeholder="æœç´¢ç”¨æˆ·å/UID/é‚€è¯·ç ..." style="width: 200px; margin: 0;">
                        <button class="btn-primary" onclick="loadUsers()">æœç´¢</button>
                        <button class="btn-primary" onclick="resetUserFilters()" style="background: #a0aec0;">é‡ç½®</button>
                        <button class="btn-primary" onclick="exportInvites()" style="background: #48bb78;">
                            <svg xmlns="http://www.w3.org/2000/svg" style="width:16px;height:16px;display:inline-block;vertical-align:middle;margin-right:4px;" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                            å¯¼å‡ºæ¨èæ•°æ®
                        </button>
                    </div>
                </div>
                <div id="userAdvancedFilters" style="margin: 12px 0; padding: 12px; background: #f7fafc; border-radius: 8px; display: none;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; font-size: 13px;">
                        <input type="text" id="filterUserId" placeholder="ç”¨æˆ·ID" style="padding: 6px 10px;">
                        <input type="text" id="filterPhone" placeholder="æ‰‹æœºå·" style="padding: 6px 10px;">
                        <input type="text" id="filterUsername" placeholder="ç”¨æˆ·å" style="padding: 6px 10px;">
                        <input type="text" id="filterLoginIp" placeholder="ç™»å½•IP" style="padding: 6px 10px;">
                        <input type="text" id="filterInviteCode" placeholder="é‚€è¯·ç " style="padding: 6px 10px;">
                        <select id="filterVipLevel" style="padding: 6px 10px;"><option value="">ç­‰çº§</option><option value="0">0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option></select>
                        <select id="filterStatus" style="padding: 6px 10px;"><option value="">çŠ¶æ€</option><option value="active">active</option><option value="banned">banned</option><option value="frozen">frozen</option></select>
                        <input type="date" id="filterCreatedFrom" placeholder="æ³¨å†Œèµ·" style="padding: 6px 10px;">
                        <input type="date" id="filterCreatedTo" placeholder="æ³¨å†Œæ­¢" style="padding: 6px 10px;">
                        <input type="number" id="filterBalanceMin" placeholder="ä½™é¢â‰¥" step="0.01" style="padding: 6px 10px;">
                        <input type="number" id="filterBalanceMax" placeholder="ä½™é¢â‰¤" step="0.01" style="padding: 6px 10px;">
                    </div>
                </div>
                <div style="margin-bottom: 8px;">
                    <button type="button" onclick="document.getElementById('userAdvancedFilters').style.display = document.getElementById('userAdvancedFilters').style.display === 'none' ? 'block' : 'none';" style="background: none; border: none; color: #718096; cursor: pointer; font-size: 12px;">â–¼ é«˜çº§æœç´¢</button>
                </div>
                
                <!-- ç”¨æˆ·ç±»å‹æ ‡ç­¾é¡µåˆ‡æ¢ -->
                <div style="margin: 20px 0; display: flex; align-items: center; justify-content: space-between;">
                    <div class="user-tabs" style="display: flex; gap: 10px;">
                        <button id="tabReal" onclick="switchUserTab('real')" style="padding: 8px 20px; background: #3182ce; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s;">
                            ğŸ‘¤ çœŸå®ç”¨æˆ· (Real Users)
                        </button>
                        <button id="tabWorker" onclick="switchUserTab('worker')" style="padding: 8px 20px; background: #e2e8f0; color: #4a5568; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s;">
                            ğŸ¤– åšå•è´¦æˆ· (Workers)
                        </button>
                    </div>
                    <button id="btnAddWorker" onclick="openAddWorkerModal()" style="padding: 8px 16px; background: #ed8936; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; display: none;">
                        â• æ·»åŠ åšå•è´¦å·
                    </button>
                </div>
                <div style="overflow-x: auto;">
                    <table id="usersTable">
                        <thead><tr><th>ID</th><th>ç”¨æˆ·å</th><th>æ‰‹æœº</th><th>ä½™é¢</th><th>å†»ç»“</th><th>æœ€è¿‘IP</th><th>é’±åŒ…</th><th>èµ„é‡‘å¯†ç </th><th>é‚€è¯·ç </th><th>æ¨èäºº</th><th>å›¢é˜Ÿ</th><th>æŠ¢å•</th><th>è¿›åº¦</th><th>çŠ¶æ€</th><th>æ³¨å†Œæ—¶é—´</th><th>æ“ä½œ</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div id="userPagination" style="margin-top: 12px; font-size: 13px; color: #718096;"></div>
            </div>

            <div class="content-card" style="margin-top: 20px;">
                <div class="card-header">
                    <div class="card-title">æ¨èå¥–åŠ±è®°å½•</div>
                    <button class="btn-primary" onclick="loadReferralRewards()">åˆ·æ–°</button>
                </div>
                <div style="overflow-x: auto;">
                    <table id="rewardsTable">
                        <thead><tr><th>ID</th><th>æ¨èäºº</th><th>è¢«æ¨èäºº</th><th>å¥–åŠ±é‡‘é¢</th><th>å‘æ”¾æ—¶é—´</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="financeView" class="view-container">
            <h1 class="view-page-title">ğŸ’° è´¢åŠ¡å®¡æ‰¹</h1>
            <p class="view-page-desc">å®¡æ ¸ç”¨æˆ·å……å€¼ä¸æç°ç”³è¯·ï¼Œé€šè¿‡æˆ–æ‹’ç»åå°†å½±å“ç”¨æˆ·ä½™é¢ä¸èµ„é‡‘æµæ°´ã€‚</p>
            <div class="mini-stats-row" id="financeMiniStats">
                <span class="mini-stat">å¾…å®¡æç°ï¼š<strong id="financePendingWithdraw">-</strong> ç¬”</span>
                <span class="mini-stat">å¾…å®¡å……å€¼ï¼š<strong id="financePendingDeposit">-</strong> ç¬”</span>
            </div>
            <div class="content-card">
                <div class="finance-tabs">
                    <button type="button" id="financeTabWithdraw" class="active" onclick="switchFinanceTab('withdraw')">æç°å®¡æ‰¹</button>
                    <button type="button" id="financeTabDeposit" onclick="switchFinanceTab('deposit')">å……å€¼å®¡æ‰¹</button>
                </div>
                <div id="financePagination" style="margin-bottom:12px;font-size:13px;color:#718096;"></div>
                <div id="financeList"></div>
            </div>
        </div>

        <div id="tasksView" class="view-container">
            <h1 class="view-page-title">ğŸ“¦ å•†å“ç®¡ç†</h1>
            <p class="view-page-desc">æ·»åŠ ä¸ç®¡ç†æŠ¢å•å•†å“ï¼Œè®¾ç½®åç§°ã€ä»·æ ¼ã€VIP ç­‰çº§ä¸å›¾ç‰‡ã€‚</p>
            <div class="split-view">
                <div class="content-card" style="height: fit-content;">
                    <div class="card-title">æ·»åŠ æŠ¢å•å•†å“</div>
                    <div style="margin-top: 20px;">
                        <input type="text" id="prodTitle" placeholder="å•†å“åç§° (å¦‚ iPhone 16)">
                        <input type="number" id="prodPrice" placeholder="ä»·æ ¼ (USDT)">
                        <select id="prodVip">
                            <option value="0" selected>å…¨å‘˜é€šç”¨</option>
                            <option value="1">VIP 1</option>
                            <option value="2">VIP 2</option>
                            <option value="3">VIP 3</option>
                            <option value="4">VIP 4</option>
                        </select>
                        <input type="text" id="prodImg" placeholder="å›¾ç‰‡URL (å¯é€‰)">
                        <button class="btn-primary" onclick="addProduct()" style="width: 100%">æ·»åŠ å•†å“</button>
                        <div style="display:flex; gap: 10px; margin-top: 10px;">
                            <button class="btn-primary" onclick="triggerProductsImport()" style="flex: 1; background: #4c51bf;">æ‰¹é‡å¯¼å…¥ (.xlsx)</button>
                            <button class="btn-primary" onclick="downloadImportTemplate()" style="flex: 1; background: #718096;">ä¸‹è½½æ¨¡æ¿</button>
                        </div>
                        <input id="prodImportFile" type="file" accept=".xlsx" style="display:none" onchange="importProductsExcel()" />
                        <div style="margin-top: 10px; font-size: 12px; color: #718096; line-height: 1.5;">
                            Excel å­—æ®µï¼šNameï¼ˆåç§°ï¼‰ã€Priceï¼ˆå•ä»·ï¼‰ã€Imageï¼ˆå›¾ç‰‡URLï¼Œå¯é€‰ï¼‰ã€‚å¯¼å…¥å•†å“é»˜è®¤è®¾ç½®ä¸ºã€Œå…¨å‘˜é€šç”¨ã€ã€‚
                        </div>
                    </div>
                </div>
                <div class="content-card">
                    <div class="card-title">å•†å“åˆ—è¡¨</div>
                    <table id="productsTable" style="margin-top: 20px;">
                        <thead><tr><th>ID</th><th>å›¾ç‰‡</th><th>åç§°</th><th>ä»·æ ¼</th><th>VIP</th><th>æ“ä½œ</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="vipView" class="view-container">
            <h1 class="view-page-title">ğŸ‘‘ VIP ç®¡ç†</h1>
            <p class="view-page-desc">ç»Ÿä¸€ç®¡ç† VIP ç­‰çº§åˆ†å±‚ï¼ˆåŒä¸€å¼ è¡¨ï¼‰ï¼Œæ”¯æŒç¼–è¾‘å…¨éƒ¨å­—æ®µï¼›ä¿å­˜æ—¶ä¼šè‡ªåŠ¨è¡¥é½å¯èƒ½ç¼ºå¤±çš„æ˜ å°„å­—æ®µã€‚</p>
            <div class="split-view">
                <div class="content-card" style="height: fit-content;">
                    <div class="card-title">æ–°å¢ / ç¼–è¾‘ VIP ç­‰çº§</div>
                    <div style="margin-top: 16px;">
                        <input type="hidden" id="vipTierId">

                        <div class="form-row">
                            <label>ç­‰çº§å±‚çº§ (level / level_order)</label>
                            <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <input type="number" id="vipTierLevel" placeholder="level (å¦‚ 1)">
                                <input type="number" id="vipTierLevelOrder" placeholder="level_order (å¦‚ 1)">
                            </div>
                            <div class="hint">ä¿å­˜æ—¶ä¼šè‡ªåŠ¨åŒæ­¥ï¼šlevel â‡„ level_order</div>
                        </div>

                        <div class="form-row">
                            <label>åç§° (name)</label>
                            <input type="text" id="vipTierName" placeholder="å¦‚ Amazon Hall">
                        </div>

                        <div class="form-row">
                            <label>é—¨æ§› (price / min_balance)</label>
                            <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <input type="number" id="vipTierPrice" placeholder="price (USDT)">
                                <input type="number" id="vipTierMinBalance" placeholder="min_balance (USDT)">
                            </div>
                            <div class="hint">ä¿å­˜æ—¶ä¼šè‡ªåŠ¨åŒæ­¥ï¼šprice â‡„ min_balance</div>
                        </div>

                        <div class="form-row">
                            <label>ä½£é‡‘æ¯”ä¾‹ (commission_rate)</label>
                            <input type="number" id="vipTierCommissionRate" placeholder="ç™¾åˆ†æ¯”ï¼Œå¦‚ 2.5 è¡¨ç¤º 2.5%" step="0.001" min="0">
                            <div class="hint">è¯¥å­—æ®µå­˜å‚¨ä¸ºå°æ•°ï¼ˆ0.025ï¼‰ï¼Œæ­¤å¤„è¾“å…¥ç™¾åˆ†æ¯”</div>
                        </div>

                        <div class="form-row">
                            <label>æ¯æ—¥å•æ•° (task_limit / daily_orders)</label>
                            <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <input type="number" id="vipTierTaskLimit" placeholder="task_limit">
                                <input type="number" id="vipTierDailyOrders" placeholder="daily_orders">
                            </div>
                            <div class="hint">ä¿å­˜æ—¶ä¼šè‡ªåŠ¨åŒæ­¥ï¼štask_limit â‡„ daily_orders</div>
                        </div>

                        <div class="form-row">
                            <label>æè¿° (description)</label>
                            <textarea id="vipTierDescription" rows="3" placeholder="å¯é€‰"></textarea>
                        </div>

                        <div style="display: flex; gap: 10px; margin-top: 8px;">
                            <button class="btn-primary" onclick="saveVipTier()" style="flex: 1">ä¿å­˜</button>
                            <button onclick="resetVipTierForm()" style="flex: 1; background: #eee;">é‡ç½®</button>
                        </div>
                    </div>
                </div>
                <div class="content-card">
                    <div class="card-header">
                        <div class="card-title">VIP åˆ†å±‚åˆ—è¡¨</div>
                        <button class="btn-primary" onclick="resetVipTierForm()">â• æ–°å¢ç­‰çº§</button>
                    </div>
                    <div style="overflow-x:auto;">
                        <table style="margin-top: 8px;">
                            <thead><tr><th>å±‚çº§</th><th>åç§°</th><th>é—¨æ§›</th><th>ä½£é‡‘</th><th>å•æ•°</th><th>æ“ä½œ</th></tr></thead>
                            <tbody id="vipTiersTable">
                                <tr><td colspan="6" style="text-align:center; color:#999;">åŠ è½½ä¸­...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- åšå•å‚æ•°è§†å›¾ -->
        <div id="orderParamsView" class="view-container">
            <h1 class="view-page-title">âš™ï¸ åšå•å‚æ•°è®¾ç½®</h1>
            <p class="view-page-desc">é…ç½®è®¢å•é‡‘é¢åŒ¹é…æ¯”ä¾‹ï¼Œç³»ç»Ÿå°†æ ¹æ®ç”¨æˆ·ä½™é¢è‡ªåŠ¨ç”Ÿæˆç¬¦åˆæ¯”ä¾‹çš„è®¢å•é‡‘é¢ã€‚</p>
            <div class="content-card" style="max-width: 600px; margin: 0 auto;">
                <div class="settings-section" style="background: linear-gradient(135deg, #f0f4ff 0%, #e8eeff 100%); border: 1px solid rgba(102,126,234,0.2); margin-bottom: 24px;">
                    <div class="settings-section-title">ğŸ“ è®¡ç®—å…¬å¼</div>
                    <p style="color: var(--text-primary); font-size: 15px; margin: 0; line-height: 1.6;">è®¢å•é‡‘é¢ = ç”¨æˆ·ä½™é¢ Ã— éšæœºæ¯”ä¾‹ (æœ€å°æ¯”ä¾‹ ~ æœ€å¤§æ¯”ä¾‹)</p>
                </div>
                
                <div class="form-row">
                    <label>ğŸ“‰ æœ€å°åŒ¹é…æ¯”ä¾‹ (Min Ratio)</label>
                    <input type="number" id="matchMinRatio" step="0.01" min="0" max="1" placeholder="0.1">
                    <div class="hint">ä¾‹å¦‚ï¼š0.1 è¡¨ç¤ºè®¢å•é‡‘é¢è‡³å°‘ä¸ºç”¨æˆ·ä½™é¢çš„ 10%</div>
                </div>
                <div class="form-row">
                    <label>ğŸ“ˆ æœ€å¤§åŒ¹é…æ¯”ä¾‹ (Max Ratio)</label>
                    <input type="number" id="matchMaxRatio" step="0.01" min="0" max="1" placeholder="0.7">
                    <div class="hint">ä¾‹å¦‚ï¼š0.7 è¡¨ç¤ºè®¢å•é‡‘é¢æœ€å¤šä¸ºç”¨æˆ·ä½™é¢çš„ 70%</div>
                </div>
                <button onclick="saveOrderParams()" class="btn-primary" style="width: 100%; padding: 14px; font-size: 16px; border-radius: 12px;">ğŸ’¾ ä¿å­˜å‚æ•°</button>
            </div>
        </div>

        <!-- ä¼šå‘˜ç­‰çº§å…¥å£å·²åˆå¹¶è‡³ VIP ç®¡ç† -->

        <!-- ä¸šåŠ¡å‘˜ç®¡ç†è§†å›¾ -->
        <div id="agentsView" class="view-container">
            <h1 class="view-page-title">ğŸ¤µ ä¸šåŠ¡å‘˜ç®¡ç†</h1>
            <p class="view-page-desc">ä¸šåŠ¡å‘˜æ‹¥æœ‰ä¸“å±æ¨å¹¿æƒé™ï¼Œå¯æŸ¥çœ‹ä¸‹çº§ç”¨æˆ·äººæ•°ä¸å›¢é˜Ÿæ€»ä½™é¢ã€‚</p>
            <div class="content-card">
                <div class="card-header">
                    <div class="card-title">ä¸šåŠ¡å‘˜åˆ—è¡¨</div>
                    <button class="btn-primary" onclick="openAgentModal()" style="padding: 8px 16px;">
                        â• æ·»åŠ ä¸šåŠ¡å‘˜
                    </button>
                </div>
                
                <p style="color: #718096; font-size: 14px; margin-bottom: 20px; padding: 0 15px;">
                    ä¸šåŠ¡å‘˜æ‹¥æœ‰ä¸“å±æ¨å¹¿æƒé™ï¼Œå¯ä»¥æŸ¥çœ‹å…¶ä¸‹çº§ç”¨æˆ·çš„æ€»äººæ•°å’Œæ€»ä½™é¢ã€‚
                </p>
                
                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>ç”¨æˆ·å</th>
                                <th>é‚€è¯·ç </th>
                                <th>ä¸‹çº§äººæ•°</th>
                                <th>å›¢é˜Ÿæ€»ä½™é¢ (USDT)</th>
                                <th>çŠ¶æ€</th>
                                <th>åˆ›å»ºæ—¶é—´</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="agentsTable">
                            <tr><td colspan="8" style="text-align:center; color:#999;">åŠ è½½ä¸­...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- æŠ¥è¡¨ç»Ÿè®¡è§†å›¾ -->
        <div id="reportsView" class="view-container">
            <h1 class="view-page-title">ğŸ“Š æ•°æ®ç»Ÿè®¡ä¸æŠ¥è¡¨</h1>
            <p class="view-page-desc">æ¯æ—¥ç»è¥æŠ¥è¡¨ä¸å…¨ç«™èµ„é‡‘æµæ°´æ˜ç»†ï¼Œæ”¯æŒæŒ‰æ—¶é—´ä¸ç±»å‹æŸ¥çœ‹ã€‚</p>
            <div class="content-card">
                <div class="card-title" style="margin-bottom: 20px;">æŠ¥è¡¨</div>
                
                <!-- æ ‡ç­¾é¡µåˆ‡æ¢ -->
                <div style="margin-bottom: 20px; display: flex; gap: 10px; border-bottom: 2px solid #e2e8f0;">
                    <button id="tabDailyReport" onclick="switchReportTab('daily')" style="padding: 10px 20px; background: #3182ce; color: white; border: none; border-radius: 8px 8px 0 0; cursor: pointer; font-weight: 500;">
                        ğŸ“ˆ æ¯æ—¥ç»è¥æŠ¥è¡¨
                    </button>
                    <button id="tabTransactions" onclick="switchReportTab('transactions')" style="padding: 10px 20px; background: #e2e8f0; color: #4a5568; border: none; border-radius: 8px 8px 0 0; cursor: pointer; font-weight: 500;">
                        ğŸ’° èµ„é‡‘æµæ°´æ˜ç»†
                    </button>
                </div>
                
                <!-- Tab 1: æ¯æ—¥æŠ¥è¡¨ -->
                <div id="dailyReportTab" style="display: block;">
                    <p style="color: #718096; font-size: 14px; margin-bottom: 15px;">
                        å±•ç¤ºè¿‡å»30å¤©çš„è¿è¥æ•°æ®ï¼ŒåŒ…æ‹¬ç”¨æˆ·å¢é•¿ã€å……å€¼æç°ã€å‡€å…¥é‡‘ç­‰å…³é”®æŒ‡æ ‡ã€‚
                    </p>
                    <div style="overflow-x: auto;">
                        <table>
                            <thead>
                                <tr>
                                    <th>æ—¥æœŸ</th>
                                    <th>æ–°å¢ç”¨æˆ·</th>
                                    <th>æ€»å……å€¼ (U)</th>
                                    <th>æ€»æç° (U)</th>
                                    <th>å‡€å…¥é‡‘ (U)</th>
                                </tr>
                            </thead>
                            <tbody id="dailyReportTable">
                                <tr><td colspan="5" style="text-align:center; color:#999;">åŠ è½½ä¸­...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Tab 2: æµæ°´æ˜ç»† -->
                <div id="transactionsTab" style="display: none;">
                    <p style="color: #718096; font-size: 14px; margin-bottom: 15px;">
                        å…¨ç«™èµ„é‡‘æµæ°´è®°å½•ï¼ŒåŒ…æ‹¬å……å€¼ã€æç°ã€ä»»åŠ¡ä½£é‡‘ã€ç³»ç»Ÿè°ƒèŠ‚ç­‰æ‰€æœ‰è´¦å˜ç±»å‹ã€‚
                    </p>
                    <div style="overflow-x: auto;">
                        <table>
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>æ—¶é—´</th>
                                    <th>ç”¨æˆ·</th>
                                    <th>ç±»å‹</th>
                                    <th>é‡‘é¢ (U)</th>
                                    <th>å¤‡æ³¨</th>
                                </tr>
                            </thead>
                            <tbody id="transactionsTable">
                                <tr><td colspan="6" style="text-align:center; color:#999;">åŠ è½½ä¸­...</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <div style="margin-top: 15px; text-align: center;">
                        <button onclick="loadMoreTransactions()" class="btn-primary" style="padding: 8px 20px;">åŠ è½½æ›´å¤š</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç™»å½•æ—¥å¿— (IP) è§†å›¾ -->
        <div id="loginLogsView" class="view-container">
            <h1 class="view-page-title">ğŸ“¡ ç™»å½•æ—¥å¿—</h1>
            <p class="view-page-desc">æŸ¥çœ‹ç”¨æˆ·ç™»å½• IPã€User-Agent åŠæ—¶é—´ï¼Œæ”¯æŒæŒ‰ç”¨æˆ· ID ç­›é€‰ã€‚</p>
            <div class="content-card">
                <div class="card-header">
                    <div class="card-title">æ—¥å¿—åˆ—è¡¨</div>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="number" id="loginLogsUserId" placeholder="æŒ‰ç”¨æˆ·IDç­›é€‰ (å¯é€‰)" style="width: 180px; margin: 0; padding: 8px 12px;">
                        <button class="btn-primary" onclick="loadLoginLogs()">æŸ¥è¯¢</button>
                        <button class="btn-primary" onclick="document.getElementById('loginLogsUserId').value=''; loadLoginLogs();" style="background: #718096;">é‡ç½®</button>
                    </div>
                </div>
                <p style="color: #718096; font-size: 13px; margin-bottom: 15px;">è®°å½•ç”¨æˆ·ç™»å½•æ—¶çš„ IP åœ°å€åŠæ—¶é—´ï¼Œæ”¯æŒæŒ‰ç”¨æˆ· ID ç­›é€‰ã€‚</p>
                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>ç”¨æˆ·ID</th>
                                <th>ç”¨æˆ·å</th>
                                <th>IP åœ°å€</th>
                                <th>User-Agent</th>
                                <th>ç™»å½•æ—¶é—´</th>
                            </tr>
                        </thead>
                        <tbody id="loginLogsTable">
                            <tr><td colspan="6" style="text-align:center; color:#999;">åŠ è½½ä¸­...</td></tr>
                        </tbody>
                    </table>
                </div>
                <div style="margin-top: 15px; color: #718096; font-size: 12px;" id="loginLogsPagination"></div>
            </div>
        </div>

        <div id="systemBaseView" class="view-container">
            <div style="max-width: 720px; margin: 0 auto;">
                <h1 class="view-page-title">ç³»ç»Ÿ Â· åŸºç¡€ä¸å±•ç¤º</h1>
                <p class="view-page-desc">å…¬å‘Šã€å®¢æœé“¾æ¥ã€å…³äºæˆ‘ä»¬ç­‰ç”¨æˆ·ç«¯å±•ç¤ºå†…å®¹ã€‚</p>
                <div class="settings-section">
                    <div class="settings-section-title">ğŸ“¢ åŸºç¡€ä¸å±•ç¤º</div>
                    <div class="form-row">
                        <label>é¦–é¡µæ»šåŠ¨å…¬å‘Š (announcement)</label>
                        <input type="text" id="setAnnounce" placeholder="è¾“å…¥å…¬å‘Šå†…å®¹ï¼Œå°†æ˜¾ç¤ºåœ¨ç”¨æˆ·ç«¯é¦–é¡µ">
                    </div>
                    <div class="form-row">
                        <label>å®¢æœé“¾æ¥ (service_url)</label>
                        <input type="text" id="setService" placeholder="https://t.me/...">
                    </div>
                    <div class="form-row">
                        <label>å…³äºæˆ‘ä»¬ (about_us)</label>
                        <textarea id="setAboutUs" rows="6" placeholder="HTML æˆ–çº¯æ–‡æœ¬"></textarea>
                    </div>
                    <div class="form-row">
                        <label>é¦–é¡µ Banner å›¾ 1 (home_banner_1)</label>
                        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
                            <input type="text" id="setHomeBanner1" placeholder="å›¾ç‰‡ URL æˆ–ç‚¹å‡»å³ä¾§ä¸Šä¼ " style="flex:1;min-width:200px;">
                            <input type="file" id="uploadBanner1" accept="image/*" style="display:none;">
                            <button type="button" class="btn-secondary" onclick="document.getElementById('uploadBanner1').click()">ä¸Šä¼ å›¾ç‰‡</button>
                        </div>
                    </div>
                    <div class="form-row">
                        <label>é¦–é¡µ Banner å›¾ 2 (home_banner_2)</label>
                        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
                            <input type="text" id="setHomeBanner2" placeholder="å›¾ç‰‡ URL æˆ–ç‚¹å‡»å³ä¾§ä¸Šä¼ " style="flex:1;min-width:200px;">
                            <input type="file" id="uploadBanner2" accept="image/*" style="display:none;">
                            <button type="button" class="btn-secondary" onclick="document.getElementById('uploadBanner2').click()">ä¸Šä¼ å›¾ç‰‡</button>
                        </div>
                    </div>
                    <div class="form-row">
                        <label>é¦–é¡µ Banner å›¾ 3 (home_banner_3)</label>
                        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
                            <input type="text" id="setHomeBanner3" placeholder="å›¾ç‰‡ URL æˆ–ç‚¹å‡»å³ä¾§ä¸Šä¼ " style="flex:1;min-width:200px;">
                            <input type="file" id="uploadBanner3" accept="image/*" style="display:none;">
                            <button type="button" class="btn-secondary" onclick="document.getElementById('uploadBanner3').click()">ä¸Šä¼ å›¾ç‰‡</button>
                        </div>
                    </div>
                    <div style="margin-top:6px; color:#718096; font-size:12px;">æ¯ä¸ªä½ç½®å¯å¡«å†™å®Œæ•´å›¾ç‰‡ URLï¼Œæˆ–ç‚¹å‡»ã€Œä¸Šä¼ å›¾ç‰‡ã€é€‰æ‹©æœ¬åœ°æ–‡ä»¶ï¼ˆä¸Šä¼ åä¼šè‡ªåŠ¨å¡«å…¥å½“å‰æ¡†ï¼Œéœ€å†ç‚¹ã€Œä¿å­˜æœ¬é¡µã€ï¼‰ã€‚</div>
                </div>
                <div class="content-card" style="padding: 20px; text-align: center;">
                    <button class="btn-primary" onclick="saveSettingsPartial(['announcement','service_url','about_us','home_banner_1','home_banner_2','home_banner_3'])" style="padding: 14px 48px; font-size: 16px; border-radius: 12px;">ä¿å­˜æœ¬é¡µ</button>
                </div>
            </div>
        </div>

        <div id="systemFinanceView" class="view-container">
            <div style="max-width: 720px; margin: 0 auto;">
                <h1 class="view-page-title">ç³»ç»Ÿ Â· è´¢åŠ¡ä¸æç°</h1>
                <p class="view-page-desc">æç°å¼€å…³ã€æ‰‹ç»­è´¹ã€æœ€ä½æç°ã€æ¨èå¥–åŠ±ç­‰ä¸šåŠ¡è§„åˆ™ã€‚</p>
                <div class="settings-section">
                    <div class="settings-section-title">ğŸ’° è´¢åŠ¡ä¸æç°</div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div class="form-row">
                            <label>æç°æ‰‹ç»­è´¹ (%) (withdraw_fee)</label>
                            <input type="number" id="setFee" placeholder="0">
                        </div>
                        <div class="form-row">
                            <label>æœ€ä½æç°é‡‘é¢ (USDT) (withdraw_min)</label>
                            <input type="number" id="setWithdrawMin" placeholder="10" min="0" step="0.01">
                            <div class="hint">ç”¨æˆ·å•ç¬”æç°ä¸èƒ½ä½äºæ­¤é‡‘é¢</div>
                        </div>
                    </div>
                    <div class="form-row">
                        <label>æç°åŠŸèƒ½å¼€å…³ (withdraw_open)</label>
                        <select id="setWithdrawOpen">
                            <option value="1">å¼€å¯ (å…è®¸æç°)</option>
                            <option value="0">å…³é—­ (ç¦æ­¢æç°)</option>
                        </select>
                    </div>
                    <div class="form-row">
                        <label>æ¨èå¥–åŠ±é‡‘é¢ (å…ƒ) (referral_reward_amount)</label>
                        <input type="number" step="0.01" id="setReferralReward" placeholder="5.00">
                        <div class="hint">æ¯æˆåŠŸæ¨è 1 äººï¼Œæ¨èäººè·å¾—çš„å¥–åŠ±é‡‘é¢</div>
                    </div>
                </div>
                <div class="content-card" style="padding: 20px; text-align: center;">
                    <button class="btn-primary" onclick="saveSettingsPartial(['withdraw_fee','withdraw_min','withdraw_open','referral_reward_amount'])" style="padding: 14px 48px; font-size: 16px; border-radius: 12px;">ä¿å­˜æœ¬é¡µ</button>
                </div>
            </div>
        </div>

        <div id="systemContentView" class="view-container">
            <div style="max-width: 720px; margin: 0 auto;">
                <h1 class="view-page-title">ç³»ç»Ÿ Â· è§„åˆ™ä¸å†…å®¹</h1>
                <p class="view-page-desc">ç”¨æˆ·ç«¯é¡µé¢å†…å®¹ï¼ˆé‚€è¯·è§„åˆ™ã€VIP è§„åˆ™ã€FAQï¼‰ã€‚æ”¯æŒ HTML æˆ–çº¯æ–‡æœ¬ã€‚</p>
                <div class="settings-section">
                    <div class="settings-section-title">ğŸ“œ è§„åˆ™ä¸å†…å®¹</div>
                    <div class="form-row">
                        <label>é‚€è¯·è§„åˆ™ (invitation_rule)</label>
                        <textarea id="setInvitationRule" rows="6" placeholder="HTML æˆ–çº¯æ–‡æœ¬"></textarea>
                    </div>
                    <div class="form-row">
                        <label>VIP è§„åˆ™ (vip_rule)</label>
                        <textarea id="setVipRule" rows="6" placeholder="HTML æˆ–çº¯æ–‡æœ¬"></textarea>
                    </div>
                    <div class="form-row">
                        <label>FAQ (faq)</label>
                        <textarea id="setFaq" rows="6" placeholder="HTML æˆ–çº¯æ–‡æœ¬"></textarea>
                    </div>
                </div>
                <div class="content-card" style="padding: 20px; text-align: center;">
                    <button class="btn-primary" onclick="saveSettingsPartial(['invitation_rule','vip_rule','faq'])" style="padding: 14px 48px; font-size: 16px; border-radius: 12px;">ä¿å­˜æœ¬é¡µ</button>
                </div>
            </div>
        </div>

        <div id="systemDepositView" class="view-container">
            <div style="max-width: 720px; margin: 0 auto;">
                <h1 class="view-page-title">ç³»ç»Ÿ Â· å……å€¼æ”¶æ¬¾</h1>
                <p class="view-page-desc">é…ç½®ç”¨æˆ·å……å€¼å¼¹çª—å±•ç¤ºçš„æ”¶æ¬¾åœ°å€ã€‚</p>
                <div class="settings-section">
                    <div class="settings-section-title">ğŸ’³ å……å€¼æ”¶æ¬¾</div>
                    <div class="form-row">
                        <label>å……å€¼åœ°å€ (deposit_address) Â· TRC20 USDT</label>
                        <input type="text" id="setDepositAddress" placeholder="è¾“å…¥ TRC20 æ”¶æ¬¾åœ°å€" style="font-family: monospace;">
                        <div class="hint">ä¿å­˜åç«‹å³ç”Ÿæ•ˆ</div>
                    </div>
                </div>
                <div class="content-card" style="padding: 20px; text-align: center;">
                    <button class="btn-primary" onclick="saveSettingsPartial(['deposit_address'])" style="padding: 14px 48px; font-size: 16px; border-radius: 12px;">ä¿å­˜æœ¬é¡µ</button>
                </div>
            </div>
        </div>

        <div id="systemFinanceConfigView" class="view-container">
            <div style="max-width:720px;margin:0 auto;">
                <h1 class="view-page-title">ç³»ç»Ÿ Â· å……å€¼æç°é…ç½®</h1>
                <p class="view-page-desc">å……å€¼/æç°æ–¹å¼ä¸è§„åˆ™ï¼Œç”¨æˆ·ç«¯æŒ‰æ­¤å±•ç¤ºã€‚ä¿å­˜åè¯·åˆ°ã€Œè´¢åŠ¡ä¸æç°ã€ç¡®è®¤ withdraw_min / withdraw_openã€‚</p>
                <div class="settings-section">
                    <div class="settings-section-title">å……å€¼</div>
                    <div class="form-row"><label>deposit_channels JSON</label><textarea id="setDepositChannels" rows="5" style="font-family:monospace;"></textarea><div class="hint">å……å€¼æ¸ é“åˆ—è¡¨ï¼Œå¦‚ [{"id":"trx","name":"TRC20-USDT","address":"xxx"}]ï¼Œç”¨æˆ·ç«¯å±•ç¤ºæ”¯ä»˜æ–¹å¼é€‰æ‹©ï¼›ç•™ç©º [] åˆ™ç”¨æ—§ç‰ˆ deposit_address</div></div>
                    <div class="form-row"><label>deposit_min_amount</label><input type="number" id="setDepositMinAmount" min="0" step="0.01"><div class="hint">å•ç¬”æœ€ä½å……å€¼é‡‘é¢ï¼ˆUSDTï¼‰ï¼Œä½äºæ­¤å€¼æ— æ³•æäº¤</div></div>
                    <div class="form-row"><label>deposit_require_hash_or_screenshot (1=å¿…å¡«)</label><select id="setDepositRequireHash"><option value="1">å¿…å¡«</option><option value="0">é€‰å¡«</option></select><div class="hint">ç”¨æˆ·å……å€¼æ˜¯å¦å¿…é¡»å¡«å†™äº¤æ˜“å“ˆå¸Œæˆ–ä¸Šä¼ æˆªå›¾</div></div>
                    <div class="form-row"><label>deposit_tips</label><textarea id="setDepositTips" rows="2"></textarea><div class="hint">å……å€¼é¡µå±•ç¤ºçš„æç¤ºæ–‡æ¡ˆï¼Œç”¨æˆ·ç«¯å¯è§ï¼ˆå¦‚ï¼šä»…æ”¯æŒ TRC20ã€åˆ°è´¦æ—¶é—´ç­‰ï¼‰</div></div>
                    <div class="form-row"><label>deposit_maintenance (1=å…³é—­)</label><select id="setDepositMaintenance"><option value="0">æ­£å¸¸</option><option value="1">ç»´æŠ¤</option></select><div class="hint">ç»´æŠ¤å¼€å¯æ—¶ç”¨æˆ·ç«¯æ— æ³•æäº¤å……å€¼ï¼Œä»…æ˜¾ç¤ºæç¤º</div></div>
                    <div class="form-row"><label>deposit_daily_limit (0=ä¸é™)</label><input type="number" id="setDepositDailyLimit" min="0"><div class="hint">å•æ—¥å……å€¼æ€»é¢ä¸Šé™ï¼ˆUSDTï¼‰ï¼Œ0 è¡¨ç¤ºä¸é™åˆ¶</div></div>
                </div>
                <div class="settings-section">
                    <div class="settings-section-title">æç°</div>
                    <div class="form-row"><label>withdraw_channels JSON</label><textarea id="setWithdrawChannels" rows="4" style="font-family:monospace;"></textarea><div class="hint">æç°æ¸ é“åˆ—è¡¨ï¼Œæ ¼å¼åŒ deposit_channelsï¼Œç”¨æˆ·ç«¯é€‰æ‹©æç°æ–¹å¼</div></div>
                    <div class="form-row"><label>withdraw_max</label><input type="number" id="setWithdrawMax" min="0" step="0.01"><div class="hint">å•ç¬”æœ€é«˜æç°é‡‘é¢ï¼ˆUSDTï¼‰</div></div>
                    <div class="form-row"><label>withdraw_fee_type</label><select id="setWithdrawFeeType"><option value="percent">percent</option><option value="fixed">fixed</option></select><div class="hint">æ‰‹ç»­è´¹ç±»å‹ï¼špercent=æŒ‰æ¯”ä¾‹æ‰£ï¼Œfixed=æ¯ç¬”å›ºå®šé‡‘é¢</div></div>
                    <div class="form-row"><label>withdraw_fee_value</label><input type="number" id="setWithdrawFeeValue" min="0" step="0.01"><div class="hint">æ‰‹ç»­è´¹å€¼ï¼špercent æ—¶ä¸ºç™¾åˆ†æ¯”ï¼ˆå¦‚ 1 è¡¨ç¤º 1%ï¼‰ï¼Œfixed æ—¶ä¸º USDT é‡‘é¢</div></div>
                    <div class="form-row"><label>withdraw_tips</label><textarea id="setWithdrawTips" rows="2"></textarea><div class="hint">æç°é¡µå±•ç¤ºçš„æç¤ºæ–‡æ¡ˆï¼Œç”¨æˆ·ç«¯å¯è§</div></div>
                    <div class="form-row"><label>withdraw_maintenance</label><select id="setWithdrawMaintenance"><option value="0">æ­£å¸¸</option><option value="1">ç»´æŠ¤</option></select><div class="hint">ç»´æŠ¤å¼€å¯æ—¶ç”¨æˆ·ç«¯æ— æ³•å‘èµ·æç°</div></div>
                    <div class="form-row"><label>withdraw_daily_count_limit / withdraw_daily_amount_limit (0=ä¸é™)</label><input type="number" id="setWithdrawDailyCountLimit" min="0"><input type="number" id="setWithdrawDailyAmountLimit" min="0" step="0.01"><div class="hint">å•æ—¥æç°æ¬¡æ•°ä¸Šé™ã€å•æ—¥æç°æ€»é¢ä¸Šé™ï¼ˆUSDTï¼‰ï¼Œ0 è¡¨ç¤ºä¸é™åˆ¶</div></div>
                </div>
                <div class="content-card" style="padding:20px;text-align:center;"><button class="btn-primary" onclick="saveFinanceConfig()">ä¿å­˜æœ¬é¡µ</button></div>
            </div>
        </div>

    </div>

    <div id="balanceModal" class="modal">
        <div class="modal-content" style="max-width: 500px; width: 90%;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0;">ğŸ’° èµ„é‡‘è°ƒèŠ‚ (Adjust Balance)</h3>
                <button onclick="document.getElementById('balanceModal').style.display='none'" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">&times;</button>
            </div>
            
            <input type="hidden" id="editUserId">
            
            <div style="margin-bottom: 15px;">
                <label style="display: block; color: #718096; font-size: 12px; margin-bottom: 5px; font-weight: 600;">ç”¨æˆ·</label>
                <div id="editUserName" style="font-weight: bold; color: #2d3748; font-size: 15px;"></div>
            </div>

            <div style="margin-bottom: 15px;">
                <label style="display: block; color: #718096; font-size: 12px; margin-bottom: 5px; font-weight: 600;">æ“ä½œç±»å‹</label>
                <select id="adjustType" style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 14px;">
                    <option value="add">â• åŠ æ¬¾ (Add Balance)</option>
                    <option value="deduct">â– æ‰£æ¬¾ (Deduct Balance)</option>
                </select>
            </div>

            <div style="margin-bottom: 15px;">
                <label style="display: block; color: #718096; font-size: 12px; margin-bottom: 5px; font-weight: 600;">é‡‘é¢ (USDT)</label>
                <input type="number" id="editAmount" placeholder="è¯·è¾“å…¥é‡‘é¢" step="0.01" min="0" style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 14px;">
            </div>

            <div style="margin-bottom: 20px;">
                <label style="display: block; color: #718096; font-size: 12px; margin-bottom: 5px; font-weight: 600;">å¤‡æ³¨</label>
                <input type="text" id="editReason" placeholder="æ“ä½œåŸå› ..." style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 14px;">
            </div>

            <div style="display: flex; gap: 10px;">
                <button onclick="document.getElementById('balanceModal').style.display='none'" style="flex: 1; padding: 10px; background: #e2e8f0; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; color: #4a5568;">å–æ¶ˆ</button>
                <button onclick="submitBalance()" class="btn-primary" style="flex: 1; padding: 10px; border-radius: 8px;">ç¡®è®¤è°ƒè´¦</button>
            </div>
        </div>
    </div>

    <!-- åšå•è´¦æˆ·åˆ›å»ºæ¨¡æ€æ¡† -->
    <div id="workerModal" class="modal">
        <div class="modal-content" style="max-width: 450px; width: 90%;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0;">ğŸ¤– æ·»åŠ åšå•è´¦æˆ·</h3>
                <button onclick="document.getElementById('workerModal').style.display='none'" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">&times;</button>
            </div>
            
            <div style="margin-bottom: 15px;">
                <label style="display: block; color: #4a5568; font-size: 14px; margin-bottom: 5px; font-weight: 500;">ç”¨æˆ·å (Username)</label>
                <input type="text" id="workerUser" placeholder="è¯·è¾“å…¥ç”¨æˆ·å..." style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 14px;">
            </div>
            
            <div style="margin-bottom: 15px;">
                <label style="display: block; color: #4a5568; font-size: 14px; margin-bottom: 5px; font-weight: 500;">å¯†ç  (Password)</label>
                <input type="text" id="workerPass" placeholder="è¯·è¾“å…¥å¯†ç ..." style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 14px;">
            </div>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; color: #4a5568; font-size: 14px; margin-bottom: 5px; font-weight: 500;">åˆå§‹ä½™é¢ (Initial Balance)</label>
                <input type="number" id="workerBal" placeholder="0.00" step="0.01" min="0" style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 14px;">
                <div style="color: #718096; font-size: 12px; margin-top: 5px;">ğŸ’¡ å¯é€‰å¡«ï¼Œé»˜è®¤ä¸º 0 USDT</div>
            </div>

            <div style="display: flex; gap: 10px;">
                <button onclick="document.getElementById('workerModal').style.display='none'" style="flex: 1; padding: 10px; background: #e2e8f0; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; color: #4a5568;">å–æ¶ˆ</button>
                <button onclick="submitWorker()" class="btn-primary" style="flex: 1; padding: 10px; border-radius: 8px;">åˆ›å»ºè´¦æˆ·</button>
            </div>
        </div>
    </div>

    <div id="passwordModal" class="modal">
        <div class="modal-content">
            <h3>å¯†ç ç®¡ç†</h3>
            <input type="hidden" id="resetUserId">
            <p id="resetUserName" style="margin: 10px 0; color: #666;"></p>
            
            <div style="margin-bottom: 15px;">
                <label style="display:block; font-size:13px; color:#666; margin-bottom:8px;">é‡ç½®ç™»å½•å¯†ç </label>
                <input type="text" id="newLoginPassword" placeholder="è¾“å…¥æ–°ç™»å½•å¯†ç  (è‡³å°‘6ä½)" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px;">
                <button onclick="resetLoginPassword()" class="btn-primary" style="width:100%; margin-top:8px; padding:8px;">é‡ç½®ç™»å½•å¯†ç </button>
            </div>
            
            <div style="border-top:1px solid #eee; padding-top:15px; margin-top:15px;">
                <label style="display:block; font-size:13px; color:#666; margin-bottom:8px;">æ¸…é™¤èµ„é‡‘å¯†ç </label>
                <p style="font-size:12px; color:#999; margin-bottom:8px;">æ¸…é™¤åç”¨æˆ·éœ€é‡æ–°è®¾ç½®</p>
                <button onclick="resetSecurityPassword()" class="btn-danger" style="width:100%; padding:8px;">æ¸…é™¤èµ„é‡‘å¯†ç </button>
            </div>
            
            <div style="margin-top:20px;">
                <button onclick="document.getElementById('passwordModal').style.display='none'" style="width:100%; padding:10px; background:#eee; border:none; border-radius:8px; cursor:pointer;">å…³é—­</button>
            </div>
        </div>
    </div>

    <!-- å›¢é˜Ÿè¯¦æƒ…æ¨¡æ€æ¡† -->
    <div id="teamModal" class="modal">
        <div class="modal-content" style="max-width: 800px; width: 90%;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0;">å›¢é˜Ÿæˆå‘˜åˆ—è¡¨</h3>
                <button onclick="document.getElementById('teamModal').style.display='none'" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">&times;</button>
            </div>
            
            <div id="teamModalContent" style="min-height: 200px;">
                <div style="text-align: center; padding: 40px; color: #999;">
                    <div class="spinner" style="margin: 0 auto 20px;"></div>
                    <p>åŠ è½½ä¸­...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ä¿®æ”¹æ¨èå…³ç³»æ¨¡æ€æ¡† -->
    <div id="referrerModal" class="modal">
        <div class="modal-content" style="max-width: 500px; width: 90%;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0;">ä¿®æ”¹æ¨èå…³ç³»</h3>
                <button onclick="document.getElementById('referrerModal').style.display='none'" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">&times;</button>
            </div>
            
            <div style="background: #fff3cd; border: 1px solid #ffc107; padding: 12px; border-radius: 8px; margin-bottom: 20px;">
                <p style="margin: 0; font-size: 13px; color: #856404;">
                    âš ï¸ <strong>æ³¨æ„</strong>ï¼šæ­¤æ“ä½œå°†æ”¹å˜ç”¨æˆ·çš„æ¨èå…³ç³»ï¼Œè¯·è°¨æ…æ“ä½œã€‚
                </p>
            </div>
            
            <div id="referrerModalContent">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #333;">
                        å½“å‰ç”¨æˆ·ï¼š<span id="currentUserName" style="color: #667eea;"></span>
                    </label>
                    <div style="font-size: 13px; color: #666; background: #f8f9fa; padding: 10px; border-radius: 6px;">
                        å½“å‰æ¨èäººï¼š<span id="currentReferrerName" style="font-weight: 600;"></span>
                    </div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #333;">
                        æ–°æ¨èäººé‚€è¯·ç ï¼š
                    </label>
                    <input 
                        type="text" 
                        id="newReferrerCode" 
                        placeholder="è¾“å…¥æ–°æ¨èäººçš„é‚€è¯·ç ï¼ˆç•™ç©ºåˆ™æ¸…é™¤æ¨èå…³ç³»ï¼‰" 
                        style="width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 14px;"
                    >
                    <p style="font-size: 12px; color: #999; margin-top: 8px;">
                        ğŸ’¡ æç¤ºï¼šå¯ä»¥åœ¨ç”¨æˆ·åˆ—è¡¨ä¸­æŸ¥çœ‹æ¯ä¸ªç”¨æˆ·çš„é‚€è¯·ç 
                    </p>
                </div>
                
                <div style="display: flex; gap: 10px;">
                    <button onclick="submitReferrerChange()" class="btn-primary" style="flex: 1;">
                        ç¡®è®¤ä¿®æ”¹
                    </button>
                    <button onclick="document.getElementById('referrerModal').style.display='none'" style="flex: 1; padding: 10px; background: #e2e8f0; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; color: #4a5568;">
                        å–æ¶ˆ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- æ´¾é€è®¢å•æ¨¡æ€æ¡† -->
    <div id="dispatchModal" class="modal">
        <div class="modal-content" style="max-width: 600px; width: 90%;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0;">ğŸ¯ æ´¾é€è®¢å•ï¼ˆé¢„è®¾æ’é˜Ÿï¼‰</h3>
                <button onclick="document.getElementById('dispatchModal').style.display='none'" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">&times;</button>
            </div>
            
            <div style="background: #ffebee; border: 1px solid #ff6b6b; padding: 12px; border-radius: 8px; margin-bottom: 20px;">
                <p style="margin: 0; font-size: 13px; color: #c62828;">
                    âš ï¸ <strong>æ´¾å•è¯´æ˜</strong>ï¼šä¸ºæŒ‡å®šç”¨æˆ·åœ¨ç‰¹å®šä»»åŠ¡ç¼–å·æ—¶åŒ¹é…å¤§é¢è®¢å•ï¼ˆåŸ‹é›·ï¼‰
                </p>
            </div>
            
            <div id="dispatchModalContent">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #333;">
                        ç›®æ ‡ç”¨æˆ·ï¼š<span id="dispatchUserName" style="color: #667eea;"></span>
                    </label>
                    <div style="font-size: 13px; color: #666; background: #f8f9fa; padding: 10px; border-radius: 6px;">
                        å½“å‰è¿›åº¦ï¼š<span id="dispatchCurrentProgress" style="font-weight: 600;">0</span> å•
                    </div>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #333;">
                        ä»»åŠ¡ç¼–å·ï¼ˆç¬¬å‡ å•è§¦å‘ï¼‰*
                    </label>
                    <input 
                        type="number" 
                        id="dispatchTaskIndex" 
                        placeholder="ä¾‹å¦‚ï¼šè¾“å…¥ 5 è¡¨ç¤ºç”¨æˆ·åšç¬¬5å•æ—¶è§¦å‘" 
                        min="1"
                        style="width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 14px;"
                    >
                    <p style="font-size: 12px; color: #999; margin-top: 5px;">
                        ğŸ’¡ ç”¨æˆ·æŠ¢åˆ°ç¬¬Nå•æ—¶ä¼šåŒ¹é…æ­¤è®¢å•
                    </p>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div>
                        <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #333;">
                            æœ€å°é‡‘é¢ (USDT)*
                        </label>
                        <input 
                            type="number" 
                            id="dispatchMinAmount" 
                            placeholder="ä¾‹å¦‚ï¼š1000" 
                            min="0"
                            step="0.01"
                            style="width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 14px;"
                        >
                    </div>
                    <div>
                        <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #333;">
                            æœ€å¤§é‡‘é¢ (USDT)*
                        </label>
                        <input 
                            type="number" 
                            id="dispatchMaxAmount" 
                            placeholder="ä¾‹å¦‚ï¼š5000" 
                            min="0"
                            step="0.01"
                            style="width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 14px;"
                        >
                    </div>
                </div>
                
                <div style="background: #e3f2fd; padding: 12px; border-radius: 8px; margin-bottom: 20px;">
                    <p style="margin: 0; font-size: 12px; color: #1565c0;">
                        ğŸ“Œ <strong>ç¤ºä¾‹</strong>ï¼šè®¾ç½®ä»»åŠ¡ç¼–å·=10ï¼Œé‡‘é¢èŒƒå›´=1000-5000ï¼Œåˆ™ç”¨æˆ·åšç¬¬10å•æ—¶ä¼šéšæœºåŒ¹é…1000-5000 USDTçš„è®¢å•
                    </p>
                </div>
                
                <div style="display: flex; gap: 10px;">
                    <button onclick="submitDispatchOrder()" class="btn-primary" style="flex: 1;">
                        ç¡®è®¤æ´¾å•
                    </button>
                    <button onclick="document.getElementById('dispatchModal').style.display='none'" style="flex: 1; padding: 10px; background: #e2e8f0; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; color: #4a5568;">
                        å–æ¶ˆ
                    </button>
                </div>
                
                <hr style="margin: 20px 0; border: none; border-top: 1px solid #e2e8f0;">
                
                <div id="dispatchOrdersList" style="max-height: 200px; overflow-y: auto;">
                    <div style="text-align: center; padding: 20px; color: #999;">
                        <div class="spinner" style="margin: 0 auto 10px;"></div>
                        <p style="font-size: 13px;">åŠ è½½å·²æ´¾è®¢å•...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api/admin';
        const token = localStorage.getItem('admin_token') || localStorage.getItem('token');
        
        // --- Core Functions ---
        
        async function fetchAPI(endpoint, options = {}) {
            if (!token) { window.location.href = 'login.html'; return; }
            options.headers = { ...options.headers, 'Authorization': 'Bearer ' + (token || ''), 'Content-Type': 'application/json' };
            try {
                const res = await fetch(API_BASE + endpoint, options);
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                const data = await res.json();
                return data;
            } catch (err) {
                console.error("API Error:", err);
                return { success: false, message: 'ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°' };
            }
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.style.transform = 'translateY(0)';
            setTimeout(() => t.style.transform = 'translateY(-100px)', 3000);
        }

        function toggleSystemMenu(event) {
            try { if (event) event.preventDefault(); } catch (e) {}
            try { if (event) event.stopPropagation(); } catch (e) {}
            const sub = document.getElementById('systemSubMenu');
            const arrow = document.getElementById('systemMenuArrow');
            if (!sub) return;
            const open = sub.classList.toggle('open');
            if (arrow) arrow.textContent = open ? 'â–¾' : 'â–¸';
        }

        function switchView(viewName, event) {
            // Remove active from all views and menus
            document.querySelectorAll('.view-container').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.menu-item').forEach(el => el.classList.remove('active'));
            
            // Activate selected
            const targetView = document.getElementById(viewName + 'View');
            if (targetView) {
                targetView.classList.add('active');
                if (event) event.currentTarget.classList.add('active');
                
                // Load data based on view
                if (viewName === 'dashboard') loadStats();
                if (viewName === 'users') {
                    loadUsers();
                    loadReferralRewards();
                }
                if (viewName === 'finance') loadWithdrawals();
                if (viewName === 'tasks') loadProducts();
                if (viewName === 'vip') loadVipTiers();
                if (viewName === 'orderParams') loadOrderParams();
                if (viewName === 'agents') loadAgents();
                if (viewName === 'reports') {
                    currentTransactionOffset = 0;
                    switchReportTab('daily');
                }
                if (viewName === 'loginLogs') loadLoginLogs();

                // System group views
                if (['systemBase', 'systemFinance', 'systemContent', 'systemDeposit', 'systemFinanceConfig'].includes(viewName)) {
                    const sub = document.getElementById('systemSubMenu');
                    const arrow = document.getElementById('systemMenuArrow');
                    if (sub && !sub.classList.contains('open')) sub.classList.add('open');
                    if (arrow) arrow.textContent = 'â–¾';
                    loadSettings();
                    if (viewName === 'systemBase') setupBannerUpload();
                }
            } else {
                console.error("View not found:", viewName + 'View');
            }
        }

        // --- Dashboard ---
        let members10dChart, deposit10dChart;
        async function loadStats() {
            const res = await fetchAPI('/stats');
            if (res.success) {
                var d = res.data;
                function set(id, val) { var e = document.getElementById(id); if (e) e.textContent = val; }
                set('statUsers', d.total_users || 0);
                set('statTodayReg', d.today_reg || 0);
                set('statYesterdayReg', d.yesterday_reg || 0);
                set('statDeposit', parseFloat(d.total_deposit || 0).toFixed(2));
                set('statTodayDeposit', parseFloat(d.today_deposit || 0).toFixed(2));
                set('statYesterdayDeposit', parseFloat(d.yesterday_deposit || 0).toFixed(2));
                set('statWithdraw', parseFloat(d.total_withdraw || 0).toFixed(2));
                set('statTodayWithdraw', parseFloat(d.today_withdraw || 0).toFixed(2));
                set('statYesterdayWithdraw', parseFloat(d.yesterday_withdraw || 0).toFixed(2));
                set('statMonthDeposit', parseFloat(d.month_deposit || 0).toFixed(2));
                set('statLastMonthDeposit', parseFloat(d.last_month_deposit || 0).toFixed(2));
                set('statMonthWithdraw', parseFloat(d.month_withdraw || 0).toFixed(2));
                set('statLastMonthWithdraw', parseFloat(d.last_month_withdraw || 0).toFixed(2));
                set('statProfit', parseFloat(d.total_profit || 0).toFixed(2));
                set('statTodayProfit', parseFloat(d.today_profit || 0).toFixed(2));
                set('statYesterdayProfit', parseFloat(d.yesterday_profit || 0).toFixed(2));
                set('statOnline', d.online_count != null ? d.online_count : 0);
                set('statOnlineCount', d.online_count != null ? d.online_count : 0);
                var listEl = document.getElementById('onlineUsersList');
                if (listEl) {
                    if (d.online_users && d.online_users.length) {
                        listEl.innerHTML = '<table style="width:100%; border-collapse:collapse;"><thead><tr style="border-bottom:1px solid #e2e8f0;"><th style="text-align:left; padding:8px;">ID</th><th style="text-align:left; padding:8px;">ç”¨æˆ·å</th><th style="text-align:left; padding:8px;">æœ€åæ´»è·ƒ</th></tr></thead><tbody>' +
                            d.online_users.map(function(u){ return '<tr style="border-bottom:1px solid #f1f5f9;"><td style="padding:8px;">'+u.id+'</td><td style="padding:8px;">'+(u.username||'-')+'</td><td style="padding:8px;">'+(u.last_active_at||'-')+'</td></tr>'; }).join('') + '</tbody></table>';
                    } else {
                        listEl.innerHTML = '<span style="color:#a0aec0;">æš‚æ— åœ¨çº¿ç”¨æˆ·ï¼ˆ10 åˆ†é’Ÿå†…æœ‰è¯·æ±‚çš„ç”¨æˆ·ä¼šæ˜¾ç¤ºåœ¨æ­¤ï¼‰</span>';
                    }
                }
                if (d.members_10d && d.members_10d.length) {
                    if (members10dChart) members10dChart.destroy();
                    members10dChart = new Chart(document.getElementById('members10dChart'), {
                        type: 'bar',
                        data: { labels: d.members_10d.map(function(x){return x.date;}), datasets: [{ label: 'æ–°å¢ä¼šå‘˜', data: d.members_10d.map(function(x){return x.count;}), backgroundColor: 'rgba(102,126,234,0.6)' }] },
                        options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
                    });
                }
                if (d.deposit_10d && d.deposit_10d.length) {
                    if (deposit10dChart) deposit10dChart.destroy();
                    deposit10dChart = new Chart(document.getElementById('deposit10dChart'), {
                        type: 'bar',
                        data: { labels: d.deposit_10d.map(function(x){return x.date;}), datasets: [{ label: 'å……å€¼(U)', data: d.deposit_10d.map(function(x){return x.amount;}), backgroundColor: 'rgba(72,187,120,0.6)' }] },
                        options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
                    });
                }
            }
        }

        let inviteChart;
        async function loadInviteTrend() {
            try {
                const res = await fetchAPI('/invite-trends');
                if (res.success && res.data) {
                    const ctx = document.getElementById('inviteTrendChart');
                    if (inviteChart) inviteChart.destroy();
                    inviteChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: res.data.map(d => d.date),
                            datasets: [{
                                label: 'æ–°å¢é‚€è¯·',
                                data: res.data.map(d => d.count),
                                borderColor: '#667eea',
                                backgroundColor: 'rgba(102,126,234,0.1)',
                                tension: 0.4,
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: { legend: { display: false } },
                            scales: { y: { beginAtZero: true } }
                        }
                    });
                }
            } catch(e) { console.error('åŠ è½½è¶‹åŠ¿å›¾å¤±è´¥:', e); }
        }

        // --- Users ---
        let currentUserType = 'real';
        let currentUserPage = 1;
        var userPageSize = 50;

        function buildUserQueryParams(page) {
            var p = new URLSearchParams();
            var search = document.getElementById('userSearch');
            if (search && search.value && search.value.trim()) p.set('search', search.value.trim());
            p.set('type', currentUserType);
            p.set('limit', userPageSize);
            p.set('offset', (((page || currentUserPage) - 1) * userPageSize));
            var ids = ['filterUserId','filterPhone','filterUsername','filterLoginIp','filterInviteCode','filterVipLevel','filterStatus','filterCreatedFrom','filterCreatedTo','filterBalanceMin','filterBalanceMax'];
            var keys = ['user_id','phone','username','login_ip','invite_code','vip_level','status','created_from','created_to','balance_min','balance_max'];
            for (var i = 0; i < ids.length; i++) {
                var el = document.getElementById(ids[i]);
                if (el && el.value && String(el.value).trim()) p.set(keys[i], String(el.value).trim());
            }
            return p.toString();
        }

        function resetUserFilters() {
            document.getElementById('userSearch').value = '';
            ['filterUserId','filterPhone','filterUsername','filterLoginIp','filterInviteCode','filterVipLevel','filterStatus','filterCreatedFrom','filterCreatedTo','filterBalanceMin','filterBalanceMax'].forEach(function(id) {
                var el = document.getElementById(id);
                if (el) el.value = '';
            });
            currentUserPage = 1;
            loadUsers();
        }

        async function loadUsers(type, page) {
            if (type) currentUserType = type;
            if (page) currentUserPage = page;
            var qs = buildUserQueryParams(currentUserPage);
            const res = await fetchAPI('/users?' + qs);
            const tbody = document.querySelector('#usersTable tbody');
            tbody.innerHTML = '';
            if (res.success && res.data.users) {
                res.data.users.forEach(u => {
                    tbody.innerHTML += `
                        <tr>
                            <td>${u.id}</td>
                            <td>${u.username}</td>
                            <td style="font-size:11px;">${u.phone || '-'}</td>
                            <td>${(u.balance || 0).toFixed(2)}</td>
                            <td>${u.frozen_balance || 0}</td>
                            <td style="font-family:monospace;font-size:11px;" title="${u.last_login_ip || '-'}">${u.last_login_ip || '-'}</td>
                            <td>
                                ${u.wallet_address 
                                    ? `<span class="badge badge-success" style="cursor:pointer; font-family:monospace; font-size:11px;" title="${u.wallet_address}" onclick="navigator.clipboard.writeText('${u.wallet_address}');showToast('åœ°å€å·²å¤åˆ¶: ${u.wallet_address.substring(0,6)}...')">${u.wallet_address.substring(0,6)}...${u.wallet_address.substring(u.wallet_address.length-4)}</span>` 
                                    : '<span class="badge" style="background:#eee;color:#999;font-size:11px;">æœªç»‘å®š</span>'
                                }
                            </td>
                            <td>
                                ${u.has_security_password 
                                    ? '<span class="badge badge-success" style="font-size:11px;">âœ… å·²è®¾ç½®</span>' 
                                    : '<span class="badge badge-warning" style="font-size:11px;">âš ï¸ æœªè®¾ç½®</span>'
                                }
                            </td>
                            <td>
                                ${u.invite_code 
                                    ? `<span class="badge badge-primary" style="cursor:pointer; font-family:monospace; font-size:11px;" title="ç‚¹å‡»å¤åˆ¶" onclick="navigator.clipboard.writeText('${u.invite_code}');showToast('é‚€è¯·ç å·²å¤åˆ¶: ${u.invite_code}')">${u.invite_code}</span>` 
                                    : '<span class="badge" style="background:#eee;color:#999;font-size:11px;">-</span>'
                                }
                            </td>
                            <td>
                                ${u.referrer_name 
                                    ? `<span style="font-size:12px;color:#667eea;">${u.referrer_name}</span>` 
                                    : '<span style="font-size:12px;color:#ccc;">-</span>'
                                }
                            </td>
                            <td>
                                ${u.team_count > 0 
                                    ? `<span class="badge" style="background:#667eea;color:white;font-size:11px;font-weight:700;cursor:pointer;" onclick="openTeamModal(${u.id}, '${u.username}', ${u.team_count})" title="ç‚¹å‡»æŸ¥çœ‹å›¢é˜Ÿæˆå‘˜">${u.team_count} äºº ğŸ‘¥</span>` 
                                    : '<span class="badge" style="background:#f0f0f0;color:#999;font-size:11px;">0 äºº</span>'
                                }
                            </td>
                            <td>
                                <label class="switch" style="margin: 0;">
                                    <input type="checkbox" ${u.allow_grab === 1 ? 'checked' : ''} onchange="toggleGrab(${u.id}, '${u.username}')">
                                    <span class="slider"></span>
                                </label>
                            </td>
                            <td style="text-align: center;">
                                <div style="display: flex; align-items: center; gap: 8px; justify-content: center;">
                                    <span style="font-weight: 600; color: #667eea;">${u.task_progress || 0}</span>
                                    <button class="btn-sm" style="background:#ff9800;color:white;padding:4px 8px;font-size:11px;" onclick="resetProgress(${u.id}, '${u.username}', ${u.task_progress || 0})" title="é‡ç½®è¿›åº¦">
                                        ğŸ”„
                                    </button>
                                </div>
                            </td>
                            <td><span class="badge ${u.status==='active'?'badge-success':'badge-danger'}">${u.status}</span></td>
                            <td>${new Date(u.created_at).toLocaleDateString()}</td>
                            <td style="white-space:nowrap;">
                                <button onclick="openBalanceModal(${u.id}, '${u.username}')" style="background:#38a169; color:white; border:none; padding:4px 8px; border-radius:4px; margin-right:4px; cursor:pointer; font-size:12px;" title="èµ„é‡‘è°ƒèŠ‚">èµ„é‡‘</button>
                                <button onclick="openDispatchModal(${u.id}, '${u.username}', ${u.task_progress})" style="background:#d69e2e; color:white; border:none; padding:4px 8px; border-radius:4px; margin-right:4px; cursor:pointer; font-size:12px;" title="æ´¾å•æ’é˜Ÿ">æ´¾å•</button>
                                <button onclick="openEditUserModal(${u.id}, '${u.username}', ${u.vip_level || 1}, ${u.credit_score || 100}, ${u.allow_withdraw})" style="background:#3182ce; color:white; border:none; padding:4px 8px; border-radius:4px; margin-right:4px; cursor:pointer; font-size:12px;" title="ç¼–è¾‘èµ„æ–™">ç¼–è¾‘</button>
                                <button onclick="resetUserProgress(${u.id})" style="background:#805ad5; color:white; border:none; padding:4px 8px; border-radius:4px; margin-right:4px; cursor:pointer; font-size:12px;" title="é‡ç½®è¿›åº¦">é‡ç½®</button>
                                ${u.status === 'banned' 
                                    ? '<button onclick="toggleUserStatus(' + u.id + ', 0)" style="background:#718096; color:white; border:none; padding:4px 8px; border-radius:4px; cursor:pointer; font-size:12px;">è§£å†»</button>' 
                                    : '<button onclick="toggleUserStatus(' + u.id + ', 1)" style="background:#e53e3e; color:white; border:none; padding:4px 8px; border-radius:4px; cursor:pointer; font-size:12px;">å†»ç»“</button>'
                                }
                            </td>
                        </tr>
                    `;
                });
            }
            var pag = res.data && res.data.pagination;
            var pagEl = document.getElementById('userPagination');
            if (pagEl && pag) {
                var totalPages = Math.ceil((pag.total || 0) / userPageSize) || 1;
                var html = 'å…± ' + (pag.total || 0) + ' æ¡ Â· ç¬¬ ' + currentUserPage + '/' + totalPages + ' é¡µ';
                if (totalPages > 1) {
                    html += ' Â· ';
                    if (currentUserPage > 1) html += '<a href="javascript:loadUsers(null,' + (currentUserPage - 1) + ')" style="color:#3182ce;margin-right:8px;">ä¸Šä¸€é¡µ</a>';
                    if (currentUserPage < totalPages) html += '<a href="javascript:loadUsers(null,' + (currentUserPage + 1) + ')" style="color:#3182ce;">ä¸‹ä¸€é¡µ</a>';
                }
                pagEl.innerHTML = html;
            }
        }

        // åˆ‡æ¢ç”¨æˆ·ç±»å‹æ ‡ç­¾é¡µ
        function switchUserTab(type) {
            currentUserType = type;
            currentUserPage = 1;
            
            // æ›´æ–°æŒ‰é’®æ ·å¼
            const tabReal = document.getElementById('tabReal');
            const tabWorker = document.getElementById('tabWorker');
            const btnAddWorker = document.getElementById('btnAddWorker');
            
            if (type === 'real') {
                tabReal.style.background = '#3182ce';
                tabReal.style.color = 'white';
                tabWorker.style.background = '#e2e8f0';
                tabWorker.style.color = '#4a5568';
                btnAddWorker.style.display = 'none';
            } else {
                tabWorker.style.background = '#3182ce';
                tabWorker.style.color = 'white';
                tabReal.style.background = '#e2e8f0';
                tabReal.style.color = '#4a5568';
                btnAddWorker.style.display = 'inline-block';
            }
            
            // é‡æ–°åŠ è½½ç”¨æˆ·åˆ—è¡¨
            loadUsers(type);
        }

        // æ‰“å¼€æ·»åŠ åšå•è´¦æˆ·æ¨¡æ€æ¡†
        function openAddWorkerModal() {
            document.getElementById('workerUser').value = '';
            document.getElementById('workerPass').value = '';
            document.getElementById('workerBal').value = '';
            document.getElementById('workerModal').style.display = 'flex';
        }

        // æäº¤åˆ›å»ºåšå•è´¦æˆ·
        async function submitWorker() {
            const username = document.getElementById('workerUser').value;
            const password = document.getElementById('workerPass').value;
            const balance = document.getElementById('workerBal').value;
            
            if (!username || !password) {
                showToast('âŒ è¯·å¡«å†™ç”¨æˆ·åå’Œå¯†ç ');
                return;
            }
            
            try {
                const res = await fetchAPI('/worker/create', {
                    method: 'POST',
                    body: JSON.stringify({ username, password, balance: parseFloat(balance) || 0 })
                });
                
                if (res.success) {
                    showToast('âœ… åšå•è´¦æˆ·åˆ›å»ºæˆåŠŸ');
                    document.getElementById('workerModal').style.display = 'none';
                    loadUsers('worker');
                } else {
                    showToast('âŒ ' + (res.message || 'åˆ›å»ºå¤±è´¥'));
                }
            } catch (e) {
                showToast('âŒ è¯·æ±‚å¤±è´¥');
                console.error(e);
            }
        }

        function openBalanceModal(id, name) {
            document.getElementById('editUserId').value = id;
            document.getElementById('editUserName').textContent = name;
            document.getElementById('adjustType').value = 'add';
            document.getElementById('editAmount').value = '';
            document.getElementById('editReason').value = '';
            document.getElementById('balanceModal').style.display = 'flex';
        }

        async function submitBalance() {
            var id = document.getElementById('editUserId').value;
            var type = document.getElementById('adjustType').value;
            var amount = document.getElementById('editAmount').value;
            var remark = document.getElementById('editReason').value;

            if (!amount) { showToast('Please enter amount'); return; }
            if (parseFloat(amount) <= 0) { showToast('Please enter a valid amount'); return; }

            try {
                var res = await fetchAPI('/adjust-balance', {
                    method: 'POST',
                    body: JSON.stringify({ user_id: parseInt(id, 10), type: type, amount: parseFloat(amount), remark: remark || '' })
                });

                if (res.success) {
                    showToast('Success');
                    document.getElementById('balanceModal').style.display = 'none';
                    loadUsers();
                } else {
                    console.error('Adjust failed:', res);
                    showToast(res.message || 'Operation failed');
                }
            } catch (e) {
                console.error(e);
                showToast('Network Error');
            }
        }

        async function toggleStatus(id, currentStatus) {
            const newStatus = currentStatus === 'active' ? 'banned' : 'active';
            if (!confirm(`ç¡®å®šè¦${newStatus === 'banned' ? 'å†»ç»“' : 'è§£å†»'}è¯¥ç”¨æˆ·å—ï¼Ÿ`)) return;
            
            const res = await fetchAPI(`/users/${id}/status`, {
                method: 'PATCH',
                body: JSON.stringify({ status: newStatus })
            });
            if (res.success) { showToast('æ“ä½œæˆåŠŸ'); loadUsers(); }
        }

        // --- Password Management ---
        function openPasswordModal(id, name) {
            document.getElementById('resetUserId').value = id;
            document.getElementById('resetUserName').textContent = 'ç”¨æˆ·: ' + name;
            document.getElementById('newLoginPassword').value = '';
            document.getElementById('passwordModal').style.display = 'flex';
        }

        async function resetLoginPassword() {
            const id = document.getElementById('resetUserId').value;
            const newPassword = document.getElementById('newLoginPassword').value;
            
            if (!newPassword || newPassword.length < 6) {
                showToast('å¯†ç è‡³å°‘6ä½');
                return;
            }
            
            if (!confirm('ç¡®å®šè¦é‡ç½®è¯¥ç”¨æˆ·çš„ç™»å½•å¯†ç å—ï¼Ÿ')) return;
            
            const res = await fetchAPI(`/users/${id}/reset-password`, {
                method: 'POST',
                body: JSON.stringify({ new_password: newPassword })
            });
            
            if (res.success) {
                showToast('ç™»å½•å¯†ç å·²é‡ç½®');
                document.getElementById('newLoginPassword').value = '';
                showToast(res.message || 'é‡ç½®å¤±è´¥');
            }
        }

        async function resetSecurityPassword() {
            const id = document.getElementById('resetUserId').value;
            
            if (!confirm('ç¡®å®šè¦æ¸…é™¤è¯¥ç”¨æˆ·çš„èµ„é‡‘å¯†ç å—ï¼Ÿç”¨æˆ·éœ€é‡æ–°è®¾ç½®ã€‚')) return;
            
            const res = await fetchAPI(`/users/${id}/reset-security-password`, {
                method: 'POST',
                body: JSON.stringify({})
            });
            
            if (res.success) {
                showToast('èµ„é‡‘å¯†ç å·²æ¸…é™¤');
                document.getElementById('passwordModal').style.display = 'none';
                loadUsers();
            } else {
                showToast(res.message || 'æ¸…é™¤å¤±è´¥');
            }
        }

        // --- å›¢é˜Ÿç®¡ç† ---
        async function openTeamModal(userId, username, teamCount) {
            const modal = document.getElementById('teamModal');
            const content = document.getElementById('teamModalContent');
            modal.style.display = 'flex';
            content.innerHTML = '<div style="text-align:center;padding:40px;"><div class="spinner" style="margin:0 auto 20px;"></div><p>åŠ è½½ä¸­...</p></div>';
            
            try {
                const res = await fetchAPI(`/users/${userId}/team`);
                if (res.success && res.data.team) {
                    const team = res.data.team;
                    if (team.length === 0) {
                        content.innerHTML = '<div style="text-align:center;padding:40px;color:#999;"><p style="font-size:48px;">ğŸ“­</p><p>è¯¥ç”¨æˆ·æš‚æ— å›¢é˜Ÿæˆå‘˜</p></div>';
                        return;
                    }
                    let html = `<div style="background:#f8f9fa;padding:15px;border-radius:12px;margin-bottom:20px;"><div style="font-size:14px;color:#666;"><strong style="color:#667eea;font-size:16px;">${username}</strong> çš„å›¢é˜Ÿ</div><div style="font-size:13px;color:#999;margin-top:5px;">å…± <strong style="color:#667eea;">${team.length}</strong> åæˆå‘˜</div></div><div style="overflow-x:auto;"><table style="width:100%;font-size:13px;"><thead><tr><th>ID</th><th>ç”¨æˆ·å</th><th>ä½™é¢</th><th>ä¸‹çº§äººæ•°</th><th>çŠ¶æ€</th><th>æ³¨å†Œæ—¶é—´</th></tr></thead><tbody>`;
                    team.forEach(m => {
                        html += `<tr><td>${m.id}</td><td><strong>${m.username}</strong></td><td>${m.balance.toFixed(2)}</td><td>${m.sub_team_count > 0 ? '<span class="badge badge-primary" style="font-size:10px;">'+m.sub_team_count+' äºº</span>' : '<span style="color:#ccc;">0</span>'}</td><td><span class="badge ${m.status === 'active' ? 'badge-success' : 'badge-danger'}" style="font-size:10px;">${m.status}</span></td><td>${new Date(m.created_at).toLocaleDateString()}</td></tr>`;
                    });
                    html += '</tbody></table></div>';
                    content.innerHTML = html;
                } else {
                    content.innerHTML = '<div style="text-align:center;padding:40px;color:#ff5858;"><p>âŒ åŠ è½½å¤±è´¥</p></div>';
                }
            } catch (err) {
                content.innerHTML = '<div style="text-align:center;padding:40px;color:#ff5858;"><p>âŒ åŠ è½½å¤±è´¥</p></div>';
            }
        }

        // --- Products ---
        async function loadProducts() {
            const res = await fetchAPI('/products');
            const tbody = document.querySelector('#productsTable tbody');
            tbody.innerHTML = '';
            if (res.success && res.data.products) {
                res.data.products.forEach(p => {
                    const vipText = (p.vip_level == null || Number(p.vip_level) === 0) ? 'é€šç”¨' : ('VIP ' + p.vip_level);
                    const imgUrl = (p.image && String(p.image).trim()) ? String(p.image).replace(/"/g, '&quot;').replace(/'/g, '&#39;') : '';
                    const placeholder = 'https://placehold.co/48x48/e2e8f0/718096?text=N/A';
                    const imgHtml = imgUrl
                        ? '<img src="' + imgUrl + '" alt="" style="width:48px;height:48px;object-fit:cover;border-radius:6px;background:#f5f5f5;" onerror="this.onerror=null;this.src=\'' + placeholder + '\';" loading="lazy">'
                        : '<span style="color:#718096;font-size:12px;">æ— å›¾</span>';
                    tbody.innerHTML += `
                        <tr>
                            <td>${p.id}</td>
                            <td>${imgHtml}</td>
                            <td>${(p.title || '').replace(/</g, '&lt;').replace(/>/g, '&gt;')}</td>
                            <td>${p.price}</td>
                            <td>${vipText}</td>
                            <td><button class="btn-sm btn-danger" onclick="deleteProduct(${p.id})">åˆ é™¤</button></td>
                        </tr>
                    `;
                });
            }
        }

        async function addProduct() {
            const data = {
                title: document.getElementById('prodTitle').value,
                price: document.getElementById('prodPrice').value,
                vip_level: document.getElementById('prodVip').value,
                image: document.getElementById('prodImg').value || `https://placehold.co/100`
            };
            const res = await fetchAPI('/products', { method: 'POST', body: JSON.stringify(data) });
            if (res.success) { showToast('å•†å“æ·»åŠ æˆåŠŸ'); loadProducts(); }
        }

        function triggerProductsImport() {
            const input = document.getElementById('prodImportFile');
            if (input) input.click();
        }

        function downloadImportTemplate() {
            // ç®€æ˜“ CSV æ¨¡æ¿ï¼ˆExcel ä¹Ÿå¯ç›´æ¥æ‰“å¼€ï¼‰
            const csv = '\ufeffName,Price,Image\nSample Product,50,https://placehold.co/100\n';
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'products-import-template.csv';
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
        }

        async function importProductsExcel() {
            const input = document.getElementById('prodImportFile');
            if (!input || !input.files || !input.files[0]) return;
            const file = input.files[0];
            try {
                const fd = new FormData();
                fd.append('file', file);
                // æ³¨æ„ï¼šè¿™é‡Œä¸èƒ½ç”¨ fetchAPIï¼ˆå®ƒä¼šå¼ºåˆ¶ Content-Type=application/jsonï¼‰
                const res = await fetch(API_BASE + '/products/import', {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + (token || '') },
                    body: fd
                });
                const data = await res.json();
                if (data && data.success) {
                    showToast(data.message || 'å¯¼å…¥æˆåŠŸ');
                    loadProducts();
                } else {
                    showToast((data && (data.message || data.error)) || 'å¯¼å…¥å¤±è´¥');
                }
            } catch (e) {
                showToast('å¯¼å…¥å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°');
                console.error(e);
            } finally {
                // æ¸…ç©ºï¼Œä¾¿äºé‡å¤é€‰æ‹©åŒä¸€æ–‡ä»¶ä¹Ÿè§¦å‘ onchange
                input.value = '';
            }
        }

        async function deleteProduct(id) {
            if (!confirm('ç¡®å®šåˆ é™¤?')) return;
            const res = await fetchAPI(`/products/${id}`, { method: 'DELETE' });
            if (res.success) { showToast('å·²åˆ é™¤'); loadProducts(); }
        }

        // --- VIP (ç»Ÿä¸€èµ° /vip-levels) ---
        let vipTierCache = [];

        async function loadVipTiers() {
            const res = await fetchAPI('/vip-levels');
            vipTierCache = (res.success && res.data) ? res.data : [];

            const tbody = document.getElementById('vipTiersTable');
            if (!tbody) return;
            tbody.innerHTML = '';

            if (!vipTierCache.length) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; color:#999;">æš‚æ— æ•°æ®</td></tr>';
                return;
            }

            vipTierCache.forEach(t => {
                const layer = (t.level_order != null && t.level_order !== '') ? t.level_order : (t.level != null ? t.level : '');
                const threshold = (t.price != null && t.price !== '') ? t.price : (t.min_balance != null ? t.min_balance : 0);
                const orders = (t.task_limit != null && t.task_limit !== '') ? t.task_limit : (t.daily_orders != null ? t.daily_orders : 0);
                const rate = (t.commission_rate != null ? (t.commission_rate * 100) : 0).toFixed(2) + '%';

                tbody.innerHTML += `
                    <tr>
                        <td><span class="badge badge-primary" style="background:#667eea;color:white">${layer}</span></td>
                        <td><strong>${t.name || '-'}</strong></td>
                        <td>${parseFloat(threshold || 0).toFixed(2)}</td>
                        <td>${rate}</td>
                        <td>${orders || 0}</td>
                        <td style="white-space:nowrap;">
                            <button class="btn-sm btn-primary" onclick="editVipTier(${t.id})">ç¼–è¾‘</button>
                            <button class="btn-sm btn-danger" onclick="deleteVipTier(${t.id})">åˆ é™¤</button>
                        </td>
                    </tr>
                `;
            });
        }

        function editVipTier(id) {
            const t = vipTierCache.find(x => x.id === id);
            if (!t) return;

            document.getElementById('vipTierId').value = t.id;
            document.getElementById('vipTierLevel').value = (t.level != null ? t.level : '');
            document.getElementById('vipTierLevelOrder').value = (t.level_order != null ? t.level_order : '');
            document.getElementById('vipTierName').value = t.name || '';
            document.getElementById('vipTierPrice').value = (t.price != null ? t.price : '');
            document.getElementById('vipTierMinBalance').value = (t.min_balance != null ? t.min_balance : '');
            document.getElementById('vipTierCommissionRate').value = (t.commission_rate != null ? (t.commission_rate * 100).toFixed(3) : '');
            document.getElementById('vipTierTaskLimit').value = (t.task_limit != null ? t.task_limit : '');
            document.getElementById('vipTierDailyOrders').value = (t.daily_orders != null ? t.daily_orders : '');
            document.getElementById('vipTierDescription').value = t.description || '';
        }

        function resetVipTierForm() {
            document.getElementById('vipTierId').value = '';
            document.getElementById('vipTierLevel').value = '';
            document.getElementById('vipTierLevelOrder').value = '';
            document.getElementById('vipTierName').value = '';
            document.getElementById('vipTierPrice').value = '';
            document.getElementById('vipTierMinBalance').value = '';
            document.getElementById('vipTierCommissionRate').value = '';
            document.getElementById('vipTierTaskLimit').value = '';
            document.getElementById('vipTierDailyOrders').value = '';
            document.getElementById('vipTierDescription').value = '';
        }

        async function saveVipTier() {
            const id = document.getElementById('vipTierId').value;
            const name = (document.getElementById('vipTierName').value || '').trim();

            let level = parseInt(document.getElementById('vipTierLevel').value);
            let level_order = parseInt(document.getElementById('vipTierLevelOrder').value);
            let price = parseFloat(document.getElementById('vipTierPrice').value);
            let min_balance = parseFloat(document.getElementById('vipTierMinBalance').value);
            let task_limit = parseInt(document.getElementById('vipTierTaskLimit').value);
            let daily_orders = parseInt(document.getElementById('vipTierDailyOrders').value);
            const commissionPct = parseFloat(document.getElementById('vipTierCommissionRate').value);
            const description = (document.getElementById('vipTierDescription').value || '').trim();

            if (!name) { showToast('âŒ è¯·å¡«å†™åç§°'); return; }

            // å­—æ®µè¡¥é½ç­–ç•¥
            if (isNaN(level) && !isNaN(level_order)) level = level_order;
            if (isNaN(level_order) && !isNaN(level)) level_order = level;
            if (isNaN(level) && isNaN(level_order)) { showToast('âŒ è¯·å¡«å†™ç­‰çº§å±‚çº§'); return; }

            if (isNaN(price) && !isNaN(min_balance)) price = min_balance;
            if (isNaN(min_balance) && !isNaN(price)) min_balance = price;
            if (isNaN(price)) price = 0;
            if (isNaN(min_balance)) min_balance = 0;

            if (isNaN(task_limit) && !isNaN(daily_orders)) task_limit = daily_orders;
            if (isNaN(daily_orders) && !isNaN(task_limit)) daily_orders = task_limit;
            if (isNaN(task_limit)) task_limit = 0;
            if (isNaN(daily_orders)) daily_orders = 0;

            const commission_rate = (!isNaN(commissionPct) ? commissionPct / 100 : 0);

            const body = {
                name,
                level,
                level_order,
                price,
                min_balance,
                commission_rate,
                task_limit,
                daily_orders,
                description
            };
            if (id) body.id = parseInt(id);

            const res = await fetchAPI('/vip-levels', { method: 'POST', body: JSON.stringify(body) });
            if (res.success) {
                showToast('âœ… ä¿å­˜æˆåŠŸ');
                resetVipTierForm();
                loadVipTiers();
            } else {
                showToast('âŒ ' + (res.message || 'ä¿å­˜å¤±è´¥'));
            }
        }

        async function deleteVipTier(id) {
            if (!confirm('ç¡®å®šåˆ é™¤è¯¥ç­‰çº§ï¼Ÿ\nå¦‚æœ‰ç”¨æˆ·æ­£åœ¨ä½¿ç”¨è¯¥ç­‰çº§ï¼Œåˆ é™¤ä¼šå¤±è´¥ã€‚')) return;
            const res = await fetchAPI('/vip-levels/' + id, { method: 'DELETE' });
            if (res.success) {
                showToast('âœ… å·²åˆ é™¤');
                loadVipTiers();
            } else {
                showToast('âŒ ' + (res.message || 'åˆ é™¤å¤±è´¥'));
            }
        }

        // --- Finance ---
        function switchFinanceTab(tab) {
            document.getElementById('financeTabWithdraw').classList.toggle('active', tab === 'withdraw');
            document.getElementById('financeTabDeposit').classList.toggle('active', tab === 'deposit');
            if (tab === 'withdraw') loadWithdrawals(); else loadDeposits();
        }

        var financeOffset = { withdraw: 0, deposit: 0 };
        async function loadWithdrawals(offset) {
            if (typeof offset !== 'number') offset = 0;
            financeOffset.withdraw = offset;
            const res = await fetchAPI('/withdrawals?limit=50&offset=' + offset);
            const list = res.data && res.data.withdrawals ? res.data.withdrawals : [];
            const pending = (res.data && res.data.pending_count != null) ? res.data.pending_count : list.filter(function(x){ return x.status === 'pending'; }).length;
            var el = document.getElementById('financePendingWithdraw'); if (el) el.textContent = pending;
            renderFinanceTable(list, 'withdraw', res.data && res.data.pagination ? res.data.pagination : null);
        }
        async function loadDeposits(offset) {
            if (typeof offset !== 'number') offset = 0;
            financeOffset.deposit = offset;
            const res = await fetchAPI('/deposits?limit=50&offset=' + offset);
            const list = res.data && res.data.deposits ? res.data.deposits : [];
            const pending = (res.data && res.data.pending_count != null) ? res.data.pending_count : list.filter(function(x){ return x.status === 'pending'; }).length;
            var el = document.getElementById('financePendingDeposit'); if (el) el.textContent = pending;
            renderFinanceTable(list, 'deposit', res.data && res.data.pagination ? res.data.pagination : null);
        }

        function renderFinanceTable(list, type, pagination) {
            const container = document.getElementById('financeList');
            const pagEl = document.getElementById('financePagination');
            if (pagEl) pagEl.innerHTML = '';
            if (!list || list.length === 0) { container.innerHTML = '<div class="empty-state"><div class="icon">ğŸ“­</div><p>æš‚æ— ' + (type === 'withdraw' ? 'æç°' : 'å……å€¼') + 'è®°å½•</p></div>'; return; }
            
            let html = `<table><thead><tr><th>ç”¨æˆ·</th><th>é‡‘é¢</th><th>çŠ¶æ€</th><th>æ—¶é—´</th><th>æ“ä½œ</th></tr></thead><tbody>`;
            list.forEach(item => {
                const actionBtns = item.status === 'pending' ? `
                    <button class="btn-sm btn-primary" onclick="reviewFinance(${item.id}, '${type}', 'approve')">é€šè¿‡</button>
                    <button class="btn-sm btn-danger" onclick="reviewFinance(${item.id}, '${type}', 'reject')">é©³å›</button>
                ` : item.status;
                
                html += `<tr>
                    <td>${item.username}</td>
                    <td>${item.amount}</td>
                    <td><span class="badge badge-${item.status==='pending'?'warning':(item.status==='approved'?'success':'danger')}">${item.status}</span></td>
                    <td>${new Date(item.created_at).toLocaleString()}</td>
                    <td>${actionBtns}</td>
                </tr>`;
            });
            html += `</tbody></table>`;
            container.innerHTML = html;
        }

        async function reviewFinance(id, type, action) {
            if (!confirm(`ç¡®å®š${action === 'approve' ? 'é€šè¿‡' : 'é©³å›'}?`)) return;
            const endpoint = type === 'withdraw' ? `/withdrawals/${id}/review` : `/deposits/${id}/review`;
            const res = await fetchAPI(endpoint, { method: 'POST', body: JSON.stringify({ action, reason: 'admin action' }) });
            if (res.success) { showToast('æ“ä½œæˆåŠŸ'); type === 'withdraw' ? loadWithdrawals() : loadDeposits(); }
            else { showToast(res.message); }
        }

        // --- Settings ---
        async function loadSettings() {
            const res = await fetchAPI('/settings');
            if (res.success && res.data) {
                document.getElementById('setAnnounce').value = res.data.announcement || '';
                document.getElementById('setService').value = res.data.service_url || '';
                document.getElementById('setFee').value = res.data.withdraw_fee || '0';
                document.getElementById('setWithdrawMin').value = res.data.withdraw_min || '10';
                document.getElementById('setReferralReward').value = res.data.referral_reward_amount || '5.00';
                document.getElementById('setWithdrawOpen').value = res.data.withdraw_open || '1';
                document.getElementById('setInvitationRule').value = res.data.invitation_rule || '';
                document.getElementById('setVipRule').value = res.data.vip_rule || '';
                document.getElementById('setFaq').value = res.data.faq || '';
                document.getElementById('setDepositAddress').value = res.data.deposit_address || '';
                if (document.getElementById('setAboutUs')) document.getElementById('setAboutUs').value = res.data.about_us || '';
                if (document.getElementById('setHomeBanner1')) document.getElementById('setHomeBanner1').value = res.data.home_banner_1 || '';
                if (document.getElementById('setHomeBanner2')) document.getElementById('setHomeBanner2').value = res.data.home_banner_2 || '';
                if (document.getElementById('setHomeBanner3')) document.getElementById('setHomeBanner3').value = res.data.home_banner_3 || '';
                if (document.getElementById('setDepositChannels')) document.getElementById('setDepositChannels').value = res.data.deposit_channels || '[]';
                if (document.getElementById('setDepositMinAmount')) document.getElementById('setDepositMinAmount').value = res.data.deposit_min_amount || '';
                if (document.getElementById('setDepositRequireHash')) document.getElementById('setDepositRequireHash').value = res.data.deposit_require_hash_or_screenshot || '1';
                if (document.getElementById('setDepositTips')) document.getElementById('setDepositTips').value = res.data.deposit_tips || '';
                if (document.getElementById('setDepositMaintenance')) document.getElementById('setDepositMaintenance').value = res.data.deposit_maintenance || '0';
                if (document.getElementById('setDepositDailyLimit')) document.getElementById('setDepositDailyLimit').value = res.data.deposit_daily_limit || '0';
                if (document.getElementById('setWithdrawChannels')) document.getElementById('setWithdrawChannels').value = res.data.withdraw_channels || '[]';
                if (document.getElementById('setWithdrawMax')) document.getElementById('setWithdrawMax').value = res.data.withdraw_max || '';
                if (document.getElementById('setWithdrawFeeType')) document.getElementById('setWithdrawFeeType').value = res.data.withdraw_fee_type || 'percent';
                if (document.getElementById('setWithdrawFeeValue')) document.getElementById('setWithdrawFeeValue').value = res.data.withdraw_fee_value || '0';
                if (document.getElementById('setWithdrawTips')) document.getElementById('setWithdrawTips').value = res.data.withdraw_tips || '';
                if (document.getElementById('setWithdrawMaintenance')) document.getElementById('setWithdrawMaintenance').value = res.data.withdraw_maintenance || '0';
                if (document.getElementById('setWithdrawDailyCountLimit')) document.getElementById('setWithdrawDailyCountLimit').value = res.data.withdraw_daily_count_limit || '0';
                if (document.getElementById('setWithdrawDailyAmountLimit')) document.getElementById('setWithdrawDailyAmountLimit').value = res.data.withdraw_daily_amount_limit || '0';
                setupBannerUpload();
            }
        }

        async function saveSettings() {
            return await saveSettingsPartial([
                'announcement',
                'service_url',
                'withdraw_fee',
                'withdraw_min',
                'referral_reward_amount',
                'withdraw_open',
                'invitation_rule',
                'vip_rule',
                'faq',
                'deposit_address',
                'about_us',
                'home_banner_1',
                'home_banner_2',
                'home_banner_3'
            ]);
        }

        async function saveSettingsPartial(keys) {
            const map = {
                announcement: 'setAnnounce',
                service_url: 'setService',
                withdraw_fee: 'setFee',
                withdraw_min: 'setWithdrawMin',
                referral_reward_amount: 'setReferralReward',
                withdraw_open: 'setWithdrawOpen',
                invitation_rule: 'setInvitationRule',
                vip_rule: 'setVipRule',
                faq: 'setFaq',
                deposit_address: 'setDepositAddress',
                about_us: 'setAboutUs',
                home_banner_1: 'setHomeBanner1',
                home_banner_2: 'setHomeBanner2',
                home_banner_3: 'setHomeBanner3',
                deposit_channels: 'setDepositChannels', deposit_min_amount: 'setDepositMinAmount', deposit_require_hash_or_screenshot: 'setDepositRequireHash', deposit_tips: 'setDepositTips', deposit_maintenance: 'setDepositMaintenance', deposit_daily_limit: 'setDepositDailyLimit',
                withdraw_channels: 'setWithdrawChannels', withdraw_max: 'setWithdrawMax', withdraw_fee_type: 'setWithdrawFeeType', withdraw_fee_value: 'setWithdrawFeeValue', withdraw_tips: 'setWithdrawTips', withdraw_maintenance: 'setWithdrawMaintenance', withdraw_daily_count_limit: 'setWithdrawDailyCountLimit', withdraw_daily_amount_limit: 'setWithdrawDailyAmountLimit'
            };

            const data = {};
            (keys || []).forEach(k => {
                const id = map[k];
                const el = id ? document.getElementById(id) : null;
                data[k] = el ? el.value : '';
            });

            const res = await fetchAPI('/settings', { method: 'POST', body: JSON.stringify(data) });
            if (res.success) { showToast('è®¾ç½®å·²ä¿å­˜'); }
            else { showToast(res.message || 'ä¿å­˜å¤±è´¥'); }
            return res;
        }

        async function saveFinanceConfig() {
            await saveSettingsPartial(['deposit_channels','deposit_min_amount','deposit_require_hash_or_screenshot','deposit_tips','deposit_maintenance','deposit_daily_limit','withdraw_channels','withdraw_max','withdraw_fee_type','withdraw_fee_value','withdraw_tips','withdraw_maintenance','withdraw_daily_count_limit','withdraw_daily_amount_limit']);
        }

        function setupBannerUpload() {
            if (window._bannerUploadBound) return;
            window._bannerUploadBound = true;
            const token = localStorage.getItem('admin_token') || localStorage.getItem('token');
            [1, 2, 3].forEach(function(n) {
                var input = document.getElementById('uploadBanner' + n);
                var textInput = document.getElementById('setHomeBanner' + n);
                if (!input || !textInput) return;
                input.addEventListener('change', async function() {
                    var file = this.files[0];
                    if (!file) return;
                    var fd = new FormData();
                    fd.append('image', file);
                    var res = await fetch(API_BASE + '/upload-banner', { method: 'POST', headers: { 'Authorization': 'Bearer ' + token }, body: fd });
                    var json = await res.json();
                    if (json.success && json.data && json.data.url) {
                        textInput.value = json.data.url;
                        showToast('ä¸Šä¼ æˆåŠŸï¼Œè¯·ç‚¹å‡»ä¿å­˜æœ¬é¡µ');
                    } else { showToast(json.message || 'ä¸Šä¼ å¤±è´¥'); }
                    this.value = '';
                });
            });
        }

        // --- å¯¼å‡ºæ¨èæ•°æ® ---
        async function exportInvites() {
            try {
                const token = localStorage.getItem('admin_token') || localStorage.getItem('token');
                const res = await fetch(API_BASE + '/export-invites', {
                    method: 'GET',
                    headers: { 'Authorization': 'Bearer ' + (token || ''), 'Content-Type': 'application/json' }
                });
                if (!res.ok) {
                    const err = await res.json().catch(() => ({}));
                    showToast(err.error || err.message || 'å¯¼å‡ºå¤±è´¥');
                    return;
                }
                const blob = await res.blob();
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `invites_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                showToast('å¯¼å‡ºæˆåŠŸï¼');
            } catch (e) {
                showToast('å¯¼å‡ºå¤±è´¥');
            }
        }

        // --- ä¿®æ”¹æ¨èå…³ç³» ---
        let currentEditUserId = null;
        
        function openReferrerModal(userId, username, currentReferrerName, userInviteCode) {
            currentEditUserId = userId;
            document.getElementById('currentUserName').textContent = username;
            document.getElementById('currentReferrerName').textContent = currentReferrerName || 'æ— ';
            document.getElementById('newReferrerCode').value = '';
            document.getElementById('referrerModal').style.display = 'flex';
        }

        async function submitReferrerChange() {
            if (!currentEditUserId) return;
            
            const newReferrerCode = document.getElementById('newReferrerCode').value.trim();
            
            // ç¡®è®¤æ“ä½œ
            const confirmMsg = newReferrerCode 
                ? `ç¡®å®šè¦å°†è¯¥ç”¨æˆ·è°ƒæ•´åˆ°é‚€è¯·ç ä¸º "${newReferrerCode}" çš„ç”¨æˆ·å›¢é˜Ÿä¸‹å—ï¼Ÿ` 
                : 'ç¡®å®šè¦æ¸…é™¤è¯¥ç”¨æˆ·çš„æ¨èå…³ç³»å—ï¼Ÿ';
            
            if (!confirm(confirmMsg)) return;
            
            try {
                const res = await fetchAPI(`/users/${currentEditUserId}/referrer`, {
                    method: 'PATCH',
                    body: JSON.stringify({ referrer_code: newReferrerCode || null })
                });
                
                if (res.success) {
                    showToast(res.message || 'ä¿®æ”¹æˆåŠŸ');
                    document.getElementById('referrerModal').style.display = 'none';
                    loadUsers(); // åˆ·æ–°ç”¨æˆ·åˆ—è¡¨
                } else {
                    showToast(res.message || 'ä¿®æ”¹å¤±è´¥');
                }
            } catch (err) {
                showToast('Operation failed: ' + err.message);
            }
        }

        // --- æ¨èå¥–åŠ±è®°å½• ---
        async function loadReferralRewards() {
            try {
                const res = await fetchAPI('/referral-rewards?page=1&limit=50');
                const tbody = document.querySelector('#rewardsTable tbody');
                if (!tbody) return;
                
                if (res.success && res.data && res.data.rewards && res.data.rewards.length > 0) {
                    let html = '';
                    res.data.rewards.forEach(item => {
                        html += `<tr>
                            <td>${item.id}</td>
                            <td>${item.referrer_name}</td>
                            <td>${item.referee_name}</td>
                            <td style="color: #48bb78; font-weight: 600;">+${item.amount} USDT</td>
                            <td>${new Date(item.created_at).toLocaleString('zh-CN')}</td>
                        </tr>`;
                    });
                    tbody.innerHTML = html;
                } else {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:#999;padding:40px;">æš‚æ— å¥–åŠ±è®°å½•</td></tr>';
                }
            } catch (e) {
                console.error('åŠ è½½å¥–åŠ±è®°å½•å¤±è´¥:', e);
                showToast('åŠ è½½å¤±è´¥');
            }
        }

        // --- ç™»å½•æ—¥å¿— (IP) ---
        let loginLogsOffset = 0;
        async function loadLoginLogs() {
            const tbody = document.querySelector('#loginLogsTable');
            const paginationEl = document.getElementById('loginLogsPagination');
            if (!tbody) return;
            const userId = document.getElementById('loginLogsUserId') && document.getElementById('loginLogsUserId').value.trim();
            try {
                let url = '/login-logs?limit=50&offset=' + (loginLogsOffset || 0);
                if (userId) url += '&user_id=' + encodeURIComponent(userId);
                const res = await fetchAPI(url);
                if (res.success && res.data && res.data.logs) {
                    const logs = res.data.logs;
                    const pagination = res.data.pagination || {};
                    if (logs.length > 0) {
                        tbody.innerHTML = logs.map(item => '<tr><td>' + item.id + '</td><td>' + item.user_id + '</td><td>' + (item.username || '-') + '</td><td style="font-family:monospace;">' + (item.ip || '-') + '</td><td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;font-size:12px;" title="' + (item.user_agent || '') + '">' + (item.user_agent ? (item.user_agent.length > 40 ? item.user_agent.substring(0, 40) + '...' : item.user_agent) : '-') + '</td><td>' + (item.created_at ? new Date(item.created_at).toLocaleString('zh-CN') : '-') + '</td></tr>').join('');
                    } else {
                        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#999;padding:40px;">æš‚æ— ç™»å½•è®°å½•</td></tr>';
                    }
                    if (paginationEl) {
                        paginationEl.textContent = 'å…± ' + (pagination.total || logs.length) + ' æ¡';
                    }
                } else {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#999;padding:40px;">åŠ è½½å¤±è´¥</td></tr>';
                }
            } catch (e) {
                console.error('åŠ è½½ç™»å½•æ—¥å¿—å¤±è´¥:', e);
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#ff5858;">åŠ è½½å¤±è´¥</td></tr>';
                if (paginationEl) paginationEl.textContent = '';
            }
        }

        // --- åˆ‡æ¢æŠ¢å•çŠ¶æ€ ---
        async function toggleGrab(userId, username) {
            try {
                const res = await fetchAPI(`/users/${userId}/toggle-grab`, {
                    method: 'POST'
                });
                
                if (res.success) {
                    showToast(res.message || 'æ“ä½œæˆåŠŸ');
                    loadUsers(); // åˆ·æ–°ç”¨æˆ·åˆ—è¡¨
                } else {
                    showToast(res.message || 'Operation failed');
                }
            } catch (err) {
                showToast('Operation failed: ' + err.message);
            }
        }

        // --- é‡ç½®ä»»åŠ¡è¿›åº¦ ---
        async function resetProgress(userId, username, currentProgress) {
            if (!confirm(`ç¡®å®šè¦å°† ${username} çš„ä»»åŠ¡è¿›åº¦é‡ç½®ä¸º0å—ï¼Ÿ\nå½“å‰è¿›åº¦ï¼š${currentProgress}`)) {
                return;
            }
            
            try {
                const res = await fetchAPI(`/users/${userId}/reset-progress`, {
                    method: 'POST'
                });
                
                if (res.success) {
                    showToast(res.message || 'é‡ç½®æˆåŠŸ');
                    loadUsers(); // åˆ·æ–°ç”¨æˆ·åˆ—è¡¨
                } else {
                    showToast(res.message || 'é‡ç½®å¤±è´¥');
                }
            } catch (err) {
                showToast('Operation failed: ' + err.message);
            }
        }

        // === æ´¾é€è®¢å• (Dispatch Order) æ ¸å¿ƒé€»è¾‘ ===
        let currentDispatchUserId = null;

        // æ‰“å¼€æ´¾å•å¼¹çª—
        function openDispatchModal(userId, username, progress) {
            currentDispatchUserId = userId;
            document.getElementById('dispatchUserName').textContent = username;
            document.getElementById('dispatchCurrentProgress').textContent = progress || 0;
            
            // é‡ç½®è¡¨å•
            document.getElementById('dispatchTaskIndex').value = '';
            document.getElementById('dispatchMinAmount').value = '';
            document.getElementById('dispatchMaxAmount').value = '';
            
            // æ˜¾ç¤ºå¼¹çª—
            document.getElementById('dispatchModal').style.display = 'flex';
            
            // åŠ è½½å·²å­˜åœ¨çš„æ´¾å•
            loadDispatchOrders(userId);
        }

        // åŠ è½½è¯¥ç”¨æˆ·çš„æ´¾å•åˆ—è¡¨
        async function loadDispatchOrders(userId) {
            const listDiv = document.getElementById('dispatchOrdersList');
            listDiv.innerHTML = '<p style="color:#666;text-align:center">Loading...</p>';
            
            try {
                const res = await fetchAPI('/users/' + userId + '/dispatch-orders');
                if (res.success && res.data && res.data.length > 0) {
                    let html = '<h4 style="margin:10px 0;font-size:14px;color:#2d3748;">å·²å®‰æ’çš„æ’é˜Ÿè®¢å•ï¼š</h4>';
                    res.data.forEach(order => {
                        html += `
                            <div style="background:#f7fafc; padding:10px; margin-bottom:8px; border-radius:6px; border:1px solid #edf2f7; display:flex; justify-content:space-between; align-items:center;">
                                <div>
                                    <span style="font-weight:bold; color:#d69e2e;">ç¬¬ ${order.task_index} å•</span>
                                    <span style="margin-left:8px; color:#4a5568;">é‡‘é¢: ${order.min_amount} - ${order.max_amount} U</span>
                                </div>
                                <button onclick="deleteDispatchOrder(${order.id})" style="background:#fff5f5; color:#c53030; border:1px solid #feb2b2; border-radius:4px; padding:4px 8px; cursor:pointer; font-size:12px;">åˆ é™¤</button>
                            </div>
                        `;
                    });
                    listDiv.innerHTML = html;
                } else {
                    listDiv.innerHTML = '<p style="color:#a0aec0;text-align:center;padding:10px;">æš‚æ— é¢„è®¾è®¢å•</p>';
                }
            } catch (e) {
                console.error(e);
                listDiv.innerHTML = '<p style="color:red;text-align:center">åŠ è½½å¤±è´¥</p>';
            }
        }

        // æäº¤æ´¾å•
        async function submitDispatchOrder() {
            if (!currentDispatchUserId) return;
            
            const taskIndex = parseInt(document.getElementById('dispatchTaskIndex').value);
            const minAmount = parseFloat(document.getElementById('dispatchMinAmount').value);
            const maxAmount = parseFloat(document.getElementById('dispatchMaxAmount').value);
            
            if (!taskIndex || taskIndex < 1) {
                showToast('è¯·è¾“å…¥æœ‰æ•ˆçš„ä»»åŠ¡ç¼–å· (ç¬¬å‡ å•)');
                return;
            }
            if (!minAmount || !maxAmount) {
                showToast('è¯·è¾“å…¥é‡‘é¢èŒƒå›´');
                return;
            }
            if (minAmount < 0 || maxAmount < 0 || maxAmount < minAmount) {
                showToast('é‡‘é¢èŒƒå›´æ— æ•ˆ (æœ€å¤§å€¼ä¸èƒ½å°äºæœ€å°å€¼)');
                return;
            }
            
            try {
                const res = await fetchAPI('/users/' + currentDispatchUserId + '/dispatch-order', {
                    method: 'POST',
                    body: JSON.stringify({
                        task_index: taskIndex,
                        min_amount: minAmount,
                        max_amount: maxAmount
                    })
                });
                
                if (res.success) {
                    showToast('âœ… æ´¾å•è®¾ç½®æˆåŠŸ');
                    // åˆ·æ–°åˆ—è¡¨å¹¶æ¸…ç©ºè¡¨å•
                    loadDispatchOrders(currentDispatchUserId);
                    document.getElementById('dispatchTaskIndex').value = '';
                    document.getElementById('dispatchMinAmount').value = '';
                    document.getElementById('dispatchMaxAmount').value = '';
                } else {
                    showToast('âŒ ' + (res.message || 'è®¾ç½®å¤±è´¥'));
                }
            } catch (e) {
                console.error(e);
                showToast('âŒ ç½‘ç»œé”™è¯¯');
            }
        }

        // åˆ é™¤æ´¾å•
        async function deleteDispatchOrder(id) {
            if (!confirm('ç¡®å®šè¦æ’¤é”€è¿™ä¸ªæ´¾å•å—ï¼Ÿ')) return;
            
            try {
                const res = await fetchAPI('/dispatch-orders/' + id, { method: 'DELETE' });
                if (res.success) {
                    showToast('ğŸ—‘ï¸ å·²åˆ é™¤');
                    loadDispatchOrders(currentDispatchUserId);
                } else {
                    showToast('åˆ é™¤å¤±è´¥');
                }
            } catch (e) {
                showToast('æ“ä½œå¤±è´¥');
            }
        }

        // === ç”¨æˆ·é«˜çº§æ§åˆ¶é€»è¾‘ ===
        function openEditUserModal(id, name, vip, credit, withdraw) {
            document.getElementById('editUserIdInput').value = id;
            document.getElementById('editUserNameInput').value = name;
            document.getElementById('editUserVipLevel').value = vip || 1;
            document.getElementById('editUserCreditScore').value = credit || 100;
            document.getElementById('editUserAllowWithdraw').value = (withdraw === undefined || withdraw === 1) ? 1 : 0;
            document.getElementById('editUserPassword').value = '';
            document.getElementById('editUserSecurityPassword').value = '';
            document.getElementById('editUserModal').style.display = 'flex';
        }

        async function submitEditUser() {
            const id = document.getElementById('editUserIdInput').value;
            const body = {
                vip_level: document.getElementById('editUserVipLevel').value,
                credit_score: document.getElementById('editUserCreditScore').value,
                allow_withdraw: document.getElementById('editUserAllowWithdraw').value,
                password: document.getElementById('editUserPassword').value || undefined,
                security_password: document.getElementById('editUserSecurityPassword').value || undefined
            };
            try {
                const res = await fetchAPI('/users/' + id + '/edit', { method: 'POST', body: JSON.stringify(body) });
                if (res.success) { showToast('âœ… ä¿®æ”¹æˆåŠŸ'); document.getElementById('editUserModal').style.display = 'none'; loadUsers(currentUserType); }
                else { showToast('âŒ ' + res.message); }
            } catch(e) { showToast('Operation failed'); }
        }

        async function toggleUserStatus(id, currentStatus) {
            if (!confirm(currentStatus === 1 ? 'âš ï¸ ç¡®å®šè¦å†»ç»“è¯¥ç”¨æˆ·å—ï¼Ÿ' : 'ç¡®å®šè§£é™¤å†»ç»“ï¼Ÿ')) return;
            try {
                const res = await fetchAPI('/users/' + id + '/toggle-status', { method: 'POST' });
                if (res.success) { showToast('æ“ä½œæˆåŠŸ'); loadUsers(currentUserType); } else showToast(res.message);
            } catch(e) { showToast('ç½‘ç»œé”™è¯¯'); }
        }

        async function resetUserProgress(id) {
            if (!confirm('ğŸ”„ ç¡®å®šé‡ç½®ä»Šæ—¥è¿›åº¦å—ï¼Ÿ')) return;
            try {
                const res = await fetchAPI('/users/' + id + '/reset-progress', { method: 'POST' });
                if (res.success) { showToast('âœ… è¿›åº¦å·²é‡ç½®'); loadUsers(currentUserType); } else showToast(res.message);
            } catch(e) { showToast('ç½‘ç»œé”™è¯¯'); }
        }

        // === åšå•å‚æ•°ç®¡ç† ===
        async function loadOrderParams() {
            try {
                const res = await fetchAPI('/system-params');
                if (res.success) {
                    document.getElementById('matchMinRatio').value = res.data.match_min_ratio;
                    document.getElementById('matchMaxRatio').value = res.data.match_max_ratio;
                }
            } catch (e) {
                console.error('åŠ è½½åšå•å‚æ•°å¤±è´¥:', e);
            }
        }

        async function saveOrderParams() {
            const minRatio = parseFloat(document.getElementById('matchMinRatio').value);
            const maxRatio = parseFloat(document.getElementById('matchMaxRatio').value);
            
            if (isNaN(minRatio) || isNaN(maxRatio)) {
                showToast('âŒ è¯·è¾“å…¥æœ‰æ•ˆçš„æ¯”ä¾‹å€¼');
                return;
            }
            if (minRatio < 0 || maxRatio > 1 || minRatio >= maxRatio) {
                showToast('âŒ æ¯”ä¾‹èŒƒå›´æ— æ•ˆ (éœ€æ»¡è¶³: 0 â‰¤ Min < Max â‰¤ 1)');
                return;
            }
            
            try {
                const res = await fetchAPI('/system-params', {
                    method: 'POST',
                    body: JSON.stringify({ match_min_ratio: minRatio, match_max_ratio: maxRatio })
                });
                if (res.success) {
                    showToast('âœ… å‚æ•°ä¿å­˜æˆåŠŸ');
                } else {
                    showToast('âŒ ' + res.message);
                }
            } catch (e) {
                showToast('âŒ ä¿å­˜å¤±è´¥');
            }
        }

        // === VIP ç­‰çº§ç®¡ç† ===
        async function loadVipLevels() {
            try {
                const res = await fetchAPI('/vip-levels');
                const tbody = document.getElementById('vipLevelsTable');
                tbody.innerHTML = '';
                
                if (res.success && res.data.length > 0) {
                    res.data.forEach(level => {
                        tbody.innerHTML += `
                            <tr>
                                <td>${level.level_order}</td>
                                <td><strong>${level.name}</strong></td>
                                <td>${(level.commission_rate * 100).toFixed(2)}%</td>
                                <td>${level.daily_orders}</td>
                                <td>${level.min_balance.toFixed(2)}</td>
                                <td style="color:#718096; font-size:12px;">${level.description || '-'}</td>
                                <td style="white-space:nowrap;">
                                    <button onclick="editVipLevel(${level.id})" style="background:#3182ce; color:white; border:none; padding:4px 12px; border-radius:4px; margin-right:5px; cursor:pointer; font-size:12px;">ç¼–è¾‘</button>
                                    <button onclick="deleteVipLevel(${level.id})" style="background:#e53e3e; color:white; border:none; padding:4px 12px; border-radius:4px; cursor:pointer; font-size:12px;">åˆ é™¤</button>
                                </td>
                            </tr>
                        `;
                    });
                } else {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; color:#999;">No Data</td></tr>';
                }
            } catch (e) {
                console.error('åŠ è½½VIPç­‰çº§å¤±è´¥:', e);
            }
        }

        function openVipLevelModal(levelId = null) {
            if (levelId) {
                // ç¼–è¾‘æ¨¡å¼
                document.getElementById('vipModalTitle').textContent = 'ç¼–è¾‘ä¼šå‘˜ç­‰çº§';
                fetchAPI('/vip-levels').then(res => {
                    const level = res.data.find(l => l.id === levelId);
                    if (level) {
                        document.getElementById('vipLevelId').value = level.id;
                        document.getElementById('vipLevelName').value = level.name;
                        document.getElementById('vipLevelOrder').value = level.level_order;
                        document.getElementById('vipCommissionRate').value = (level.commission_rate * 100).toFixed(3);
                        document.getElementById('vipDailyOrders').value = level.daily_orders;
                        document.getElementById('vipMinBalance').value = level.min_balance;
                        document.getElementById('vipDescription').value = level.description || '';
                    }
                });
            } else {
                // æ–°å»ºæ¨¡å¼
                document.getElementById('vipModalTitle').textContent = 'æ·»åŠ ä¼šå‘˜ç­‰çº§';
                document.getElementById('vipLevelId').value = '';
                document.getElementById('vipLevelName').value = '';
                document.getElementById('vipLevelOrder').value = '';
                document.getElementById('vipCommissionRate').value = '';
                document.getElementById('vipDailyOrders').value = '';
                document.getElementById('vipMinBalance').value = '0';
                document.getElementById('vipDescription').value = '';
            }
            document.getElementById('vipLevelModal').style.display = 'flex';
        }

        function editVipLevel(id) {
            openVipLevelModal(id);
        }

        async function submitVipLevel() {
            const id = document.getElementById('vipLevelId').value;
            const name = document.getElementById('vipLevelName').value.trim();
            const levelOrder = parseInt(document.getElementById('vipLevelOrder').value);
            const commissionRate = parseFloat(document.getElementById('vipCommissionRate').value) / 100;
            const dailyOrders = parseInt(document.getElementById('vipDailyOrders').value);
            const minBalance = parseFloat(document.getElementById('vipMinBalance').value);
            const description = document.getElementById('vipDescription').value.trim();
            
            if (!name || isNaN(levelOrder) || isNaN(commissionRate) || isNaN(dailyOrders)) {
                showToast('âŒ è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ');
                return;
            }
            
            try {
                const body = {
                    name, level_order: levelOrder, commission_rate: commissionRate,
                    daily_orders: dailyOrders, min_balance: minBalance, description
                };
                if (id) body.id = parseInt(id);
                
                const res = await fetchAPI('/vip-levels', {
                    method: 'POST',
                    body: JSON.stringify(body)
                });
                
                if (res.success) {
                    showToast('âœ… ä¿å­˜æˆåŠŸ');
                    document.getElementById('vipLevelModal').style.display = 'none';
                    loadVipLevels();
                } else {
                    showToast('âŒ ' + res.message);
                }
            } catch (e) {
                showToast('âŒ Operation failed');
            }
        }

        async function deleteVipLevel(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªVIPç­‰çº§å—ï¼Ÿ\næ³¨æ„ï¼šå¦‚æœæœ‰ç”¨æˆ·æ­£åœ¨ä½¿ç”¨æ­¤ç­‰çº§ï¼Œå°†æ— æ³•åˆ é™¤ã€‚')) return;
            
            try {
                const res = await fetchAPI('/vip-levels/' + id, { method: 'DELETE' });
                if (res.success) {
                    showToast('âœ… å·²åˆ é™¤');
                    loadVipLevels();
                } else {
                    showToast('âŒ ' + res.message);
                }
            } catch (e) {
                showToast('âŒ Operation failed');
            }
        }

        // === ä¸šåŠ¡å‘˜ç®¡ç†é€»è¾‘ ===
        async function loadAgents() {
            try {
                const res = await fetchAPI('/agents');
                const tbody = document.getElementById('agentsTable');
                tbody.innerHTML = '';
                
                const agents = res.data && res.data.agents ? res.data.agents : [];
                if (res.success && agents.length > 0) {
                    agents.forEach(agent => {
                        const statusBadge = agent.status === 'active' 
                            ? '<span class="badge badge-success">æ­£å¸¸</span>' 
                            : '<span class="badge badge-danger">å†»ç»“</span>';
                        
                        tbody.innerHTML += `
                            <tr>
                                <td>${agent.id}</td>
                                <td><strong>${agent.username}</strong></td>
                                <td>
                                    <span class="badge badge-primary" style="cursor:pointer; font-family:monospace;" 
                                          onclick="navigator.clipboard.writeText('${agent.invite_code}');showToast('é‚€è¯·ç å·²å¤åˆ¶')" 
                                          title="ç‚¹å‡»å¤åˆ¶">${agent.invite_code}</span>
                                </td>
                                <td><strong style="color:#667eea;">${agent.member_count}</strong> äºº</td>
                                <td><strong style="color:#48bb78;">${agent.total_team_balance.toFixed(2)}</strong> U</td>
                                <td>${statusBadge}</td>
                                <td>${new Date(agent.created_at).toLocaleDateString()}</td>
                                <td style="white-space:nowrap;">
                                    <button onclick="toggleAgentStatus(${agent.id}, '${agent.status}')" 
                                            style="background:${agent.status === 'active' ? '#e53e3e' : '#718096'}; color:white; border:none; padding:4px 12px; border-radius:4px; margin-right:5px; cursor:pointer; font-size:12px;">
                                        ${agent.status === 'active' ? 'å†»ç»“' : 'è§£å†»'}
                                    </button>
                                    <button onclick="deleteAgent(${agent.id})" 
                                            style="background:#e53e3e; color:white; border:none; padding:4px 12px; border-radius:4px; cursor:pointer; font-size:12px;">åˆ é™¤</button>
                                </td>
                            </tr>`;
                    });
                } else {
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; color:#999;">æš‚æ— ä¸šåŠ¡å‘˜</td></tr>';
                }
            } catch (e) { console.error(e); showToast('åŠ è½½å¤±è´¥'); }
        }

        function openAgentModal() {
            document.getElementById('agentUsername').value = '';
            document.getElementById('agentPassword').value = '';
            document.getElementById('agentRemark').value = '';
            document.getElementById('agentModal').style.display = 'flex';
        }

        async function submitAgent() {
            const username = document.getElementById('agentUsername').value.trim();
            const password = document.getElementById('agentPassword').value.trim();
            const remark = document.getElementById('agentRemark').value.trim();
            
            if (!username || !password) return showToast('âŒ è¯·å¡«å†™ç”¨æˆ·åå’Œå¯†ç ');
            
            try {
                const res = await fetchAPI('/agent/create', { method: 'POST', body: JSON.stringify({ username, password, remark }) });
                if (res.success) { showToast('âœ… åˆ›å»ºæˆåŠŸ'); document.getElementById('agentModal').style.display = 'none'; loadAgents(); }
                else showToast('âŒ ' + res.message);
            } catch (e) { showToast('åˆ›å»ºå¤±è´¥'); }
        }

        async function toggleAgentStatus(id, currentStatus) {
            if (!confirm('ç¡®å®šåˆ‡æ¢çŠ¶æ€ï¼Ÿ')) return;
            try {
                const res = await fetchAPI('/agents/' + id + '/toggle-status', { method: 'POST' });
                if (res.success) { showToast('æ“ä½œæˆåŠŸ'); loadAgents(); } else showToast(res.message);
            } catch (e) { showToast('æ“ä½œå¤±è´¥'); }
        }

        async function deleteAgent(id) {
            if (!confirm('ç¡®å®šåˆ é™¤è¯¥ä¸šåŠ¡å‘˜å—ï¼Ÿå¦‚æœæœ‰ä¸‹çº§ç”¨æˆ·å°†æ— æ³•åˆ é™¤ã€‚')) return;
            try {
                const res = await fetchAPI('/agents/' + id, { method: 'DELETE' });
                if (res.success) { showToast('âœ… å·²åˆ é™¤'); loadAgents(); } else showToast('âŒ ' + res.message);
            } catch (e) { showToast('æ“ä½œå¤±è´¥'); }
        }

        // === æŠ¥è¡¨ç»Ÿè®¡ç³»ç»Ÿ ===
        let currentTransactionOffset = 0;
        
        function switchReportTab(tab) {
            const tabDaily = document.getElementById('tabDailyReport');
            const tabTrans = document.getElementById('tabTransactions');
            const dailyDiv = document.getElementById('dailyReportTab');
            const transDiv = document.getElementById('transactionsTab');
            
            if (tab === 'daily') {
                tabDaily.style.background = '#3182ce';
                tabDaily.style.color = 'white';
                tabTrans.style.background = '#e2e8f0';
                tabTrans.style.color = '#4a5568';
                dailyDiv.style.display = 'block';
                transDiv.style.display = 'none';
                loadDailyReports();
            } else {
                tabTrans.style.background = '#3182ce';
                tabTrans.style.color = 'white';
                tabDaily.style.background = '#e2e8f0';
                tabDaily.style.color = '#4a5568';
                transDiv.style.display = 'block';
                dailyDiv.style.display = 'none';
                currentTransactionOffset = 0;
                loadAllTransactions();
            }
        }

        async function loadDailyReports() {
            try {
                const res = await fetchAPI('/reports/daily');
                const tbody = document.getElementById('dailyReportTable');
                tbody.innerHTML = '';
                
                if (res.success && res.data.length > 0) {
                    res.data.forEach(report => {
                        const netClass = report.net_inflow >= 0 ? 'color:#48bb78;' : 'color:#e53e3e;';
                        tbody.innerHTML += `
                            <tr>
                                <td>${report.date}</td>
                                <td><strong style="color:#667eea;">${report.new_users}</strong></td>
                                <td><strong style="color:#48bb78;">${report.total_deposit.toFixed(2)}</strong></td>
                                <td><strong style="color:#e53e3e;">${report.total_withdraw.toFixed(2)}</strong></td>
                                <td><strong style="${netClass}">${report.net_inflow >= 0 ? '+' : ''}${report.net_inflow.toFixed(2)}</strong></td>
                            </tr>
                        `;
                    });
                } else {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; color:#999;">No Data</td></tr>';
                }
            } catch (e) {
                console.error('åŠ è½½æ¯æ—¥æŠ¥è¡¨å¤±è´¥:', e);
                document.getElementById('dailyReportTable').innerHTML = '<tr><td colspan="5" style="text-align:center; color:red;">åŠ è½½å¤±è´¥</td></tr>';
            }
        }

        async function loadAllTransactions() {
            try {
                const res = await fetchAPI('/transactions/all?limit=100&offset=' + currentTransactionOffset);
                const tbody = document.getElementById('transactionsTable');
                
                if (currentTransactionOffset === 0) {
                    tbody.innerHTML = '';
                }
                
                if (res.success && res.data.transactions.length > 0) {
                    res.data.transactions.forEach(t => {
                        const typeMap = {
                            'deposit': 'ğŸ’³ å……å€¼',
                            'withdraw': 'ğŸ’¸ æç°',
                            'task_commission': 'ğŸ“¦ ä»»åŠ¡ä½£é‡‘',
                            'referral_reward': 'ğŸ æ¨èå¥–åŠ±',
                            'system_add': 'â• ç³»ç»ŸåŠ æ¬¾',
                            'system_deduct': 'â– ç³»ç»Ÿæ‰£æ¬¾'
                        };
                        const typeLabel = typeMap[t.type] || t.type;
                        const amountColor = t.type.includes('add') || t.type.includes('deposit') || t.type.includes('commission') || t.type.includes('reward') ? '#48bb78' : '#e53e3e';
                        
                        tbody.innerHTML += `
                            <tr>
                                <td>${t.id}</td>
                                <td style="font-size:12px;">${new Date(t.created_at).toLocaleString()}</td>
                                <td>${t.username || 'N/A'}</td>
                                <td><span style="font-size:12px; color:#718096;">${typeLabel}</span></td>
                                <td><strong style="color:${amountColor};">${t.amount.toFixed(2)}</strong></td>
                                <td style="color:#718096; font-size:12px;">${t.description || '-'}</td>
                            </tr>
                        `;
                    });
                } else if (currentTransactionOffset === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; color:#999;">æš‚æ— æµæ°´è®°å½•</td></tr>';
                }
            } catch (e) {
                console.error('åŠ è½½æµæ°´è®°å½•å¤±è´¥:', e);
            }
        }

        function loadMoreTransactions() {
            currentTransactionOffset += 100;
            loadAllTransactions();
        }

        async function logout() {
            var token = localStorage.getItem('admin_token') || localStorage.getItem('token');
            try {
                await fetch('/api/auth/logout', {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' }
                });
            } catch (error) {
                console.error('Logout error:', error);
            }
            localStorage.removeItem('admin_token');
            localStorage.removeItem('token');
            window.location.href = 'login.html';
        }

        // Init
        loadStats();
        loadInviteTrend();
    </script>

    <!-- ç¼–è¾‘ç”¨æˆ·æ¨¡æ€æ¡† -->
    <div id="editUserModal" class="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); align-items:center; justify-content:center; z-index:1000;">
        <div class="modal-inner-scroll" style="background:white; padding:25px; width:450px; border-radius:8px; box-shadow:0 4px 6px rgba(0,0,0,0.1);">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                <h3 style="margin:0;">âœï¸ ç¼–è¾‘ç”¨æˆ·</h3>
                <span onclick="document.getElementById('editUserModal').style.display='none'" style="cursor:pointer; font-size:20px;">&times;</span>
            </div>
            <input type="hidden" id="editUserIdInput">
            <div style="margin-bottom:10px;"><label style="color:#718096; font-size:12px;">ç”¨æˆ·å</label><input type="text" id="editUserNameInput" readonly style="width:100%; padding:8px; background:#f7fafc; border:1px solid #e2e8f0; border-radius:4px;"></div>
            <div style="display:flex; gap:10px; margin-bottom:10px;">
                <div style="flex:1;"><label style="color:#718096; font-size:12px;">VIPç­‰çº§</label><select id="editUserVipLevel" style="width:100%; padding:8px; border:1px solid #e2e8f0; border-radius:4px;"><option value="1">VIP 1</option><option value="2">VIP 2</option><option value="3">VIP 3</option><option value="4">VIP 4</option><option value="5">VIP 5</option></select></div>
                <div style="flex:1;"><label style="color:#718096; font-size:12px;">ä¿¡ç”¨åˆ†</label><input type="number" id="editUserCreditScore" style="width:100%; padding:8px; border:1px solid #e2e8f0; border-radius:4px;"></div>
            </div>
            <div style="margin-bottom:10px;"><label style="color:#718096; font-size:12px;">æç°æƒé™</label><select id="editUserAllowWithdraw" style="width:100%; padding:8px; border:1px solid #e2e8f0; border-radius:4px;"><option value="1">âœ… å…è®¸æç°</option><option value="0">ğŸš« ç¦æ­¢æç°</option></select></div>
            <div style="margin-bottom:10px;"><label style="color:#718096; font-size:12px;">ç™»å½•å¯†ç  (ç•™ç©ºä¸æ”¹)</label><input type="text" id="editUserPassword" placeholder="New Password" style="width:100%; padding:8px; border:1px solid #e2e8f0; border-radius:4px;"></div>
            <div style="margin-bottom:20px;"><label style="color:#718096; font-size:12px;">èµ„é‡‘å¯†ç  (ç•™ç©ºä¸æ”¹)</label><input type="text" id="editUserSecurityPassword" placeholder="New Security Password" style="width:100%; padding:8px; border:1px solid #e2e8f0; border-radius:4px;"></div>
            <div style="display:flex; justify-content:flex-end; gap:10px;"><button onclick="document.getElementById('editUserModal').style.display='none'" style="padding:8px 16px; background:#edf2f7; border:none; border-radius:4px; cursor:pointer;">å–æ¶ˆ</button><button onclick="submitEditUser()" style="padding:8px 16px; background:#3182ce; color:white; border:none; border-radius:4px; cursor:pointer;">ä¿å­˜ä¿®æ”¹</button></div>
        </div>
    </div>

    <!-- VIPç­‰çº§ç¼–è¾‘æ¨¡æ€æ¡† -->
    <div id="vipLevelModal" class="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); align-items:center; justify-content:center; z-index:1000;">
        <div class="modal-inner-scroll" style="background:white; padding:25px; width:500px; border-radius:8px; box-shadow:0 4px 6px rgba(0,0,0,0.1);">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                <h3 style="margin:0;">ğŸ‘‘ <span id="vipModalTitle">æ·»åŠ ä¼šå‘˜ç­‰çº§</span></h3>
                <span onclick="document.getElementById('vipLevelModal').style.display='none'" style="cursor:pointer; font-size:20px;">&times;</span>
            </div>
            
            <input type="hidden" id="vipLevelId">
            
            <div style="display:flex; gap:10px; margin-bottom:12px;">
                <div style="flex:1;">
                    <label style="color:#718096; font-size:12px; display:block; margin-bottom:5px;">ç­‰çº§åç§°</label>
                    <input type="text" id="vipLevelName" placeholder="VIP 1" style="width:100%; padding:8px; border:1px solid #e2e8f0; border-radius:4px;">
                </div>
                <div style="flex:1;">
                    <label style="color:#718096; font-size:12px; display:block; margin-bottom:5px;">æ’åºé¡ºåº</label>
                    <input type="number" id="vipLevelOrder" placeholder="1" min="1" style="width:100%; padding:8px; border:1px solid #e2e8f0; border-radius:4px;">
                </div>
            </div>
            
            <div style="display:flex; gap:10px; margin-bottom:12px;">
                <div style="flex:1;">
                    <label style="color:#718096; font-size:12px; display:block; margin-bottom:5px;">æ”¶ç›Šç‡ (%)</label>
                    <input type="number" id="vipCommissionRate" placeholder="0.5" step="0.001" min="0" max="100" style="width:100%; padding:8px; border:1px solid #e2e8f0; border-radius:4px;">
                    <p style="font-size:11px; color:#999; margin-top:2px;">è¾“å…¥ç™¾åˆ†æ¯”ï¼Œå¦‚ 0.5 è¡¨ç¤º 0.5%</p>
                </div>
                <div style="flex:1;">
                    <label style="color:#718096; font-size:12px; display:block; margin-bottom:5px;">æ¯æ—¥ä»»åŠ¡æ•°</label>
                    <input type="number" id="vipDailyOrders" placeholder="40" min="1" style="width:100%; padding:8px; border:1px solid #e2e8f0; border-radius:4px;">
                </div>
            </div>
            
            <div style="margin-bottom:12px;">
                <label style="color:#718096; font-size:12px; display:block; margin-bottom:5px;">å‡çº§é—¨æ§› (USDT)</label>
                <input type="number" id="vipMinBalance" placeholder="0" step="0.01" min="0" style="width:100%; padding:8px; border:1px solid #e2e8f0; border-radius:4px;">
                <p style="font-size:11px; color:#999; margin-top:2px;">ç”¨æˆ·ä½™é¢è¾¾åˆ°æ­¤é‡‘é¢è‡ªåŠ¨å‡çº§</p>
            </div>
            
            <div style="margin-bottom:20px;">
                <label style="color:#718096; font-size:12px; display:block; margin-bottom:5px;">æè¿°</label>
                <input type="text" id="vipDescription" placeholder="æ–°æ‰‹ä¼šå‘˜" style="width:100%; padding:8px; border:1px solid #e2e8f0; border-radius:4px;">
            </div>
            
            <div style="display:flex; justify-content:flex-end; gap:10px;">
                <button onclick="document.getElementById('vipLevelModal').style.display='none'" style="padding:8px 16px; background:#edf2f7; border:none; border-radius:4px; cursor:pointer;">å–æ¶ˆ</button>
                <button onclick="submitVipLevel()" style="padding:8px 16px; background:#3182ce; color:white; border:none; border-radius:4px; cursor:pointer;">ä¿å­˜</button>
            </div>
        </div>
    </div>
    
    <!-- ä¸šåŠ¡å‘˜åˆ›å»ºæ¨¡æ€æ¡† -->
    <div id="agentModal" class="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); align-items:center; justify-content:center; z-index:1000;">
        <div class="modal-inner-scroll" style="background:white; padding:25px; width:400px; border-radius:8px; box-shadow:0 4px 6px rgba(0,0,0,0.1);">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                <h3 style="margin:0; color:#2d3748;">ğŸ¤µ åˆ›å»ºä¸šåŠ¡å‘˜è´¦å·</h3>
                <span onclick="document.getElementById('agentModal').style.display='none'" style="cursor:pointer; font-size:20px;">&times;</span>
            </div>
            <p style="color:#718096; font-size:13px; margin-bottom:20px;">ç³»ç»Ÿå°†è‡ªåŠ¨ç”Ÿæˆä¸“å±é‚€è¯·ç ï¼Œç”¨äºç»Ÿè®¡ä¸‹çº§ä¸šç»©ã€‚</p>
            <div style="margin-bottom:15px;">
                <label style="display:block; color:#718096; font-size:12px; margin-bottom:5px;">ç”¨æˆ·å</label>
                <input type="text" id="agentUsername" placeholder="Enter username" style="width:100%; padding:10px; border:1px solid #e2e8f0; border-radius:4px;">
            </div>
            <div style="margin-bottom:15px;">
                <label style="display:block; color:#718096; font-size:12px; margin-bottom:5px;">ç™»å½•å¯†ç </label>
                <input type="text" id="agentPassword" placeholder="Enter password" style="width:100%; padding:10px; border:1px solid #e2e8f0; border-radius:4px;">
            </div>
            <div style="margin-bottom:20px;">
                <label style="display:block; color:#718096; font-size:12px; margin-bottom:5px;">å¤‡æ³¨ (å¯é€‰)</label>
                <input type="text" id="agentRemark" placeholder="e.g. Region A Sales" style="width:100%; padding:10px; border:1px solid #e2e8f0; border-radius:4px;">
            </div>
            <div style="display:flex; justify-content:flex-end; gap:10px;">
                <button onclick="document.getElementById('agentModal').style.display='none'" style="padding:10px 20px; background:#edf2f7; border:none; border-radius:4px; cursor:pointer;">å–æ¶ˆ</button>
                <button onclick="submitAgent()" style="padding:10px 20px; background:#3182ce; color:white; border:none; border-radius:4px; cursor:pointer;">åˆ›å»ºè´¦å·</button>
            </div>
        </div>
    </div>
</body>
</html>
